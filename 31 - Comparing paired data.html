
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Comparing paired data &#8212; The Python Companion of Intuitive Biostatistics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '31 - Comparing paired data';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Correlation" href="32%20-%20Correlation.html" />
    <link rel="prev" title="Comparing two unpaired means" href="30%20-%20Comparing%20two%20unpaired%20means.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.jpg" class="logo__image only-light" alt="The Python Companion of Intuitive Biostatistics - Home"/>
    <script>document.write(`<img src="_static/logo.jpg" class="logo__image only-dark" alt="The Python Companion of Intuitive Biostatistics - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    Python Companion Guide to “Intuitive Biostatistics”
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Continuous variables</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="09%20-%20Quantifying%20scatter%20of%20continuous%20data.html">Quantifying scatter of continuous data</a></li>
<li class="toctree-l1"><a class="reference internal" href="10%20-%20Gaussian%20distribution.html">The Gaussian distribution</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Confidence intervals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="12%20-%20Confidence%20interval%20of%20a%20mean.html">Confidence interval of a mean</a></li>
<li class="toctree-l1"><a class="reference internal" href="04%20-%20Confidence%20interval%20of%20a%20proportion.html">Confidence interval of a proportion</a></li>
<li class="toctree-l1"><a class="reference internal" href="05%20-%20Confidence%20interval%20of%20survival%20data.html">Confidence interval of survival data</a></li>
<li class="toctree-l1"><a class="reference internal" href="06%20-%20Confidence%20interval%20of%20counted%20data.html">Confidence interval of counted data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Statistical significance and data assumptions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="15%20-%20Statistical%20significance.html">Statistical significance</a></li>
<li class="toctree-l1"><a class="reference internal" href="20%20-%20Statistical%20power%20and%20sample%20size.html">Statistical power and sample size</a></li>
<li class="toctree-l1"><a class="reference internal" href="24%20-%20Normality%20tests%20and%20outliers.html">Normality tests and outliers</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Statistical tests</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="27%20-%20Comparing%20proportions.html">Comparing proportions</a></li>
<li class="toctree-l1"><a class="reference internal" href="29%20-%20Comparing%20survival%20curves.html">Comparing survival curves</a></li>
<li class="toctree-l1"><a class="reference internal" href="30%20-%20Comparing%20two%20unpaired%20means.html">Comparing two unpaired means</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Comparing paired data</a></li>
<li class="toctree-l1"><a class="reference internal" href="32%20-%20Correlation.html">Correlation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Fitting models to data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="33%20-%20Simple%20linear%20regression.html">Simple linear regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="35%20-%20Comparing%20models.html">Comparing models</a></li>
<li class="toctree-l1"><a class="reference internal" href="36%20-%20Nonlinear%20regression.html">Nonlinear regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="37%20-%20Multiple%20regression.html">Multiple regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="38%20-%20Logistic%20regression.html">Logistic regression</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">The rest of statistics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="39%20-%20ANOVA.html">ANOVA</a></li>
<li class="toctree-l1"><a class="reference internal" href="21%20-%20Meta-analysis.html">Meta-analysis {#sec-meta-analysis}</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/sbwiecko/intuitive_biostatistics" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/sbwiecko/intuitive_biostatistics/edit/master/31 - Comparing paired data.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/31 - Comparing paired data.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Comparing paired data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-data-for-hypothesis-testing">Preparing data for hypothesis testing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#descriptive-statistics">Descriptive statistics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-visualization">Data visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-assumptions">Assessing assumptions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#normality-testing">Normality testing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#note-on-homoscedasticity">Note on homoscedasticity</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-the-significance-of-paired-difference-mean-with-t-test">Assessing the significance of paired difference mean with t-test</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-t-ratio">The t-ratio</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#manual-calculation">Manual calculation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#p-value">P value</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-test-results">Visualizing the test results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-interval">Confidence interval</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-the-paired-t-test-in-python">Performing the paired t-test in Python</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#follow-up-analyses">Follow-up analyses</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#effect-size">Effect size</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-effectiveness-of-pairing">Evaluating the effectiveness of pairing</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extensions-of-the-paired-t-test">Extensions of the paired t-test</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-sided-t-test">One-sided t-test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ratio-paired-t-test">Ratio paired t-test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mcnemar-s-test">McNemar’s test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bayesian-approach">Bayesian approach</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-parametric-approach">Non-parametric approach</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-the-wilcoxon-signed-rand-test-manually">Performing the Wilcoxon signed-rand test manually</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exact-test">Exact test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#asymptotic-approach">Asymptotic approach</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-tools-for-the-non-parametric-paired-t-test">Python tools for the non-parametric paired t-test</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapping-and-permutation-tests-for-paired-data">Bootstrapping and permutation tests for paired data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-bootstrap-pair-samples">Generating bootstrap pair samples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-of-the-confidence-interval-for-the-paired-difference-mean">Estimate of the confidence interval for the paired difference mean</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapping-with-pingouin">Bootstrapping with Pingouin</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrap-p-value-for-paired-data">Bootstrap P value for paired data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapped-t-statistics-of-shifted-differences">Bootstrapped t-statistics of shifted differences</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-tailed-p-value">One-tailed P value</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#p-value-via-permutation">P value via permutation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cheat-sheet">Cheat sheet</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#descriptive-statistics-and-visualization">Descriptive statistics and visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Assessing assumptions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Normality testing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#q-q-plot">Q-Q plot</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test">T-test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#non-parametric-wilcoxon-signed-rank-test">Non-parametric Wilcoxon signed-rank test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapping-and-permutation-tests">Bootstrapping and permutation tests</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrap-pair-samples">Bootstrap pair samples</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">P value</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Bootstrapped t-statistics of shifted differences</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#permutation">Permutation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#session-information">Session information</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="comparing-paired-data">
<h1>Comparing paired data<a class="headerlink" href="#comparing-paired-data" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>In hypothesis testing, the <strong>paired t-test</strong> is an indispensable tool when we need to ascertain if there’s a genuine difference within the same group or individuals, but at two distinct points in time or under two different conditions. This scenario is commonplace in a variety of research contexts, such as evaluating the effectiveness of a training program by comparing participants’ performance before and after the program, or assessing the impact of a new diet on patients’ cholesterol levels by examining their readings before and after adopting the diet. The paired t-test empowers us to glean statistically robust insights from such data, facilitating informed decision-making.</p>
<p>The hallmark of the paired t-test is its focus on <strong>paired or matched data</strong>. Here, each observation in one group has a corresponding observation in the other group. This pairing could stem from repeated measurements on the same subjects (e.g., before-and-after measurements), or it could involve matching subjects based on relevant characteristics (e.g., age, gender) to minimize confounding factors. The test zeroes in on the <em>differences</em> between these paired observations, gauging whether the average difference is statistically significant or merely attributable to chance.</p>
<p>Before embarking on a paired t-test analysis, it’s imperative to ensure our data aligns with certain assumptions:</p>
<ul class="simple">
<li><p><strong>Normality</strong>: the <em>differences</em> between the paired observations should ideally conform to a normal distribution. However, like its unpaired counterpart, the paired t-test exhibits reasonable resilience to moderate departures from normality, particularly when dealing with larger sample sizes.</p></li>
<li><p><strong>Independence</strong>: the <em>differences</em> between the paired observations should be independent of each other.</p></li>
</ul>
<p>At its core, the paired t-test operates by computing a test statistic (as discussed in details in the chapter on the unpaired t-test) that encapsulates the <em>average difference</em> between the paired observations relative to the variability of these differences. This test statistic adheres to a well-defined distribution (the <strong>t-distribution</strong>, also covered in a preivous chapter) under the null hypothesis of no difference. By juxtaposing the calculated test statistic with the anticipated distribution, we derive a P value. Should the P value dip below our predetermined significance level (α), we reject the null hypothesis and infer the presence of a statistically significant difference.</p>
<p>In the forthcoming sections, we’ll embark on a deeper exploration of the mathematical underpinnings of the paired t-test, explore its practical applications through illustrative examples, and equip ourselves with the knowledge and confidence to wield this test effectively in your own analytical endeavors.</p>
</section>
<section id="preparing-data-for-hypothesis-testing">
<h2>Preparing data for hypothesis testing<a class="headerlink" href="#preparing-data-for-hypothesis-testing" title="Link to this heading">#</a></h2>
<section id="descriptive-statistics">
<h3>Descriptive statistics<a class="headerlink" href="#descriptive-statistics" title="Link to this heading">#</a></h3>
<p>In this section, we will introduce the importance of descriptive statistics and visualization in understanding the characteristics of the paired data being compared. We will emphasize how these techniques provide valuable insights into the central tendency, spread, and distribution of the differences between the paired observations, which are crucial for interpreting the results of the paired t-test.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/The_Design_of_Experiments">Fisher analyzed an experiment</a> conducted by Charles Darwin, where the <a class="reference external" href="https://en.wikipedia.org/wiki/The_Effects_of_Cross_and_self_fertililisation_in_the_Vegetable_Kingdom">growth of plants</a> originating from <em>self-fertilized</em> seeds was compared to those from <em>cross-fertilized</em> seeds. To ensure fairness, Darwin planted these seeds in pairs, side-by-side, effectively controlling for any environmental factors (like soil quality, temperature, or sunlight) that might influence both types of seeds. The data below showcases one such matched set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We use the data from Table 31.1 (page 307) of the book Intuitive Biostatistics 4th Edition</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Import the raw data as Series; unit is inches</span>
<span class="n">crossed_fertil</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="p">[</span><span class="mf">23.5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mf">19.125</span><span class="p">,</span> <span class="mf">21.5</span><span class="p">,</span> <span class="mf">22.125</span><span class="p">,</span> <span class="mf">20.375</span><span class="p">,</span> <span class="mf">18.250</span><span class="p">,</span> <span class="mf">21.625</span><span class="p">,</span> <span class="mf">23.250</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mf">22.125</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
<span class="n">self_fertil</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="p">[</span><span class="mf">17.375</span><span class="p">,</span> <span class="mf">20.375</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">18.375</span><span class="p">,</span> <span class="mf">18.625</span><span class="p">,</span> <span class="mf">18.625</span><span class="p">,</span> <span class="mf">15.25</span><span class="p">,</span> <span class="mf">16.5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mf">16.25</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mf">12.75</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="mi">18</span><span class="p">])</span>
<span class="c1"># note that each row represents a paired observation</span>

<span class="c1"># Concatenate the data in a DataFrame for some operations</span>
<span class="n">data_fert</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">crossed_fertil</span><span class="p">,</span> <span class="n">self_fertil</span><span class="p">],</span>
    <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;crossed_fertil&#39;</span><span class="p">,</span> <span class="s1">&#39;self_fertil&#39;</span><span class="p">],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Performing descriptive statistics and visualization is just as crucial in the context of a paired t-test as it is in unpaired tests. However, we need to adapt our approach to focus on the <strong>differences</strong> between the paired observations, as these differences form the core of the paired t-test analysis.</p>
<p>Utilizing a dictionary or a DataFrame enhances the clarity of the data structure and simplifies subsequent analysis and visualization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the difference between cross-fertilization and self-fertilization for each pair</span>
<span class="c1">#differences_fert = data_fert[&#39;crossed_fertil&#39;] - data_fert[&#39;self_fertil&#39;]</span>
<span class="n">differences_fert</span> <span class="o">=</span> <span class="n">crossed_fertil</span> <span class="o">-</span> <span class="n">self_fertil</span>

<span class="c1"># Print or display the calculated differences</span>
<span class="nb">print</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0     6.125
1    -8.375
2     1.000
3     2.000
4     0.750
5     2.875
6     3.500
7     5.125
8     1.750
9     3.625
10    7.000
11    3.000
12    9.375
13    7.500
14   -6.000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>

<span class="c1"># Descriptive statistics of the differences</span>
<span class="n">differences_fert_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Descriptive statistics for the differences:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">differences_fert_stats</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Descriptive statistics for the differences:
 DescribeResult(nobs=15, minmax=(-8.375, 9.375), mean=2.6166666666666667, variance=22.259970238095235, skewness=-0.9920929151820244, kurtosis=0.6057395436698894)
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-visualization">
<h3>Data visualization<a class="headerlink" href="#data-visualization" title="Link to this heading">#</a></h3>
<p>In paired data analysis, visualizing the differences between the paired values is crucial for gaining insights into the data and assessing the assumptions of the paired t-test. These visualizations help us understand the magnitude and direction of the changes, identify potential outliers, and check if the differences follow a roughly normal distribution. Common visualization techniques for paired data differences include:</p>
<ul class="simple">
<li><p>Boxplots: provide a compact summary of the distribution of the differences, including median, quartiles, and potential outliers.</p></li>
<li><p>Before-after plots: show how each individual pair’s values change, highlighting overall trends and individual variations.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Create the stripplot</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">differences_fert</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>

<span class="c1"># Add a boxplot on the right side</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">differences_fert</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
    <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Show mean as a point inside the boxplot</span>
    <span class="n">fliersize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Hide outliers from boxplot to avoid visual clutter</span>
    <span class="c1"># Custumize a few elements of the plot</span>
    <span class="n">boxprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">},</span>  <span class="c1"># Make the boxplot transparent</span>
    <span class="n">medianprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">},</span>
    <span class="n">meanprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;markerfacecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;markeredgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Add a horizontal line at y=0 (no difference)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># Set plot labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Difference in height (in)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of height differences</span><span class="se">\n</span><span class="s1">(crossed - self fertilized)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/10650b9d39751df3a00bed4f74a1aac3cda8e6571155fc0d2f55abbea04d19d9.png" src="_images/10650b9d39751df3a00bed4f74a1aac3cda8e6571155fc0d2f55abbea04d19d9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pingouin</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;future.no_silent_downcasting&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">))</span>

<span class="n">pg</span><span class="o">.</span><span class="n">plot_paired</span><span class="p">(</span>
    <span class="c1"># We need to reshape the DataFrame in the long format</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data_fert</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;crossed_fertil&#39;</span><span class="p">,</span> <span class="s1">&#39;self_fertil&#39;</span><span class="p">],</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
        <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;fertilization&#39;</span><span class="p">,</span>
        <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;plant_height&#39;</span><span class="p">),</span>
    <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;plant_height&#39;</span><span class="p">,</span>
    <span class="n">within</span><span class="o">=</span><span class="s1">&#39;fertilization&#39;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
    <span class="n">boxplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span>
    <span class="c1"># boxplot_in_front=False,  # fix submitted via a PR</span>
    <span class="n">boxplot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;zorder&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># type: ignore</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Plant height (in)&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>  <span class="c1"># not default in Pingouin anymore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/816023b80408dd897d7589465c556c6447f9d7602d9d37cc1eb666c484798b18.png" src="_images/816023b80408dd897d7589465c556c6447f9d7602d9d37cc1eb666c484798b18.png" />
</div>
</div>
<p>The lines connecting the pairs of data points are color-coded to highlight changes: green indicates an increase, indianred a decrease, and grey signifies no change between the two measurements.</p>
</section>
<section id="assessing-assumptions">
<h3>Assessing assumptions<a class="headerlink" href="#assessing-assumptions" title="Link to this heading">#</a></h3>
<p>Before proceeding with any hypothesis test, it’s crucial to verify that our data adheres to the underlying assumptions of the chosen statistical method. This subsection emphasizes the importance of checking for normality, a common assumption in many parametric tests, including the paired t-test. We’ll briefly discuss the methods used to assess this assumption, such as normality tests and visual inspections of histograms or Q-Q plots, as discussed in greater details in the chapter about normality test. These tests help us gauge whether the observed <em>differences</em> between paired observations align with the expected characteristics of a normal distribution.</p>
<section id="normality-testing">
<h4>Normality testing<a class="headerlink" href="#normality-testing" title="Link to this heading">#</a></h4>
<p>One of the fundamental assumptions of the paired t-test is that the <strong>differences</strong> between the paired observations are approximately normally distributed. To assess this assumption, we employ normality tests such as the D’Agostino-Pearson omnibus K² and Shapiro-Wilk tests, or visual inspections of histograms or Q-Q plots.  These tests help us gauge whether the observed differences align with the expected characteristics of a normal distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># D&#39;Agostino-Pearson K² test</span>
<span class="n">k2_diff</span><span class="p">,</span> <span class="n">pval_k2_diff</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">normaltest</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Differences between paired observations</span><span class="se">\t</span><span class="s2">D&#39;Agostino-Pearson omnibus:</span><span class="se">\n\</span>
<span class="s2">K2=</span><span class="si">{</span><span class="n">k2_diff</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, P value=</span><span class="si">{</span><span class="n">pval_k2_diff</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Shapiro-Wilk</span>
<span class="n">shapiro_diff</span><span class="p">,</span> <span class="n">pval_shapiro_diff</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Differences between paired observations</span><span class="se">\t</span><span class="s2">Shapiro-Wilk&#39;s normality test:</span><span class="se">\n\</span>
<span class="s2">P value=</span><span class="si">{</span><span class="n">pval_shapiro_diff</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Interpret the results</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># Set the desired significance level</span>

<span class="k">if</span> <span class="n">pval_k2_diff</span> <span class="o">&gt;</span> <span class="n">alpha</span> <span class="ow">or</span> <span class="n">pval_shapiro_diff</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The differences are not inconsistent with a normal distribution</span><span class="se">\n\</span>
<span class="s2">(failed to reject null hypothesis of normality)&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The differences are not consistent with a normal distribution&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Differences between paired observations	D&#39;Agostino-Pearson omnibus:
K2=5.21, P value=0.074
Differences between paired observations	Shapiro-Wilk&#39;s normality test:
P value=0.098

The differences are not inconsistent with a normal distribution
(failed to reject null hypothesis of normality)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\Sébastien\Documents\data_science\biostatistics\intuitive_biostatistics\.env\Lib\site-packages\scipy\stats\_axis_nan_policy.py:418: UserWarning: `kurtosistest` p-value may be inaccurate with fewer than 20 observations; only n=15 observations were given.
  return hypotest_fun_in(*args, **kwds)
</pre></div>
</div>
</div>
</div>
<p>Similar to our approach in unpaired t-tests, we can utilize the pingouin library for normality testing and Q-Q plotting in the context of paired t-tests, directly on the dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to perform tests and print results</span>
<span class="k">def</span> <span class="nf">normality_tests</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sample_type</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Test&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;W&#39;</span><span class="si">:</span><span class="s2">&lt;6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;P value&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;normal&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normality tests for </span><span class="si">{</span><span class="n">sample_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1"># D&#39;Agostino-Pearson Test</span>
    <span class="n">dagostino_results</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">normality</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normaltest&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;D</span><span class="se">\&#39;</span><span class="s1">Agostino-Pearson&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dagostino_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;6.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="si">{</span><span class="n">dagostino_results</span><span class="p">[</span><span class="s1">&#39;pval&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dagostino_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Shapiro-Wilk Test</span>
    <span class="n">shapiro_results</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">normality</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;shapiro&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Shapiro-Wilk&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shapiro_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;6.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="si">{</span><span class="n">shapiro_results</span><span class="p">[</span><span class="s1">&#39;pval&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shapiro_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

<span class="c1"># Perform tests and print results</span>
<span class="n">normality_tests</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">,</span> <span class="s2">&quot;difference between paired observations&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normality tests for difference between paired observations
Test                 W      P value  normal
D&#39;Agostino-Pearson   5.21   0.074    True
Shapiro-Wilk         0.90   0.098    True
-------------------------------------------
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting Q-Q plot</span>
<span class="n">pg</span><span class="o">.</span><span class="n">qqplot</span><span class="p">(</span>
    <span class="n">differences_fert</span><span class="p">,</span>
    <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span>
    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Q-Q plot: difference between paired observations&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d563873e71ad6251ee6c6f11034e8bed638fae7090cad4c0f36330bd968092eb.png" src="_images/d563873e71ad6251ee6c6f11034e8bed638fae7090cad4c0f36330bd968092eb.png" />
</div>
</div>
<p>While the paired t-test is also reasonably robust to moderate deviations from normality in the differences between paired observations, especially with larger sample sizes, severe violations can impact the accuracy of the test’s results. When the normality assumption is not met for the differences, the calculated P value may be unreliable, potentially leading to incorrect conclusions about the statistical significance of the mean difference.</p>
<p>In such cases, we have a few options:</p>
<ul class="simple">
<li><p>Transform the differences: if the differences exhibit a clear pattern of non-normality, we might attempt to transform them to achieve a more normal distribution.</p></li>
<li><p>Use a non-parametric alternative: when transformations are ineffective or impractical, we can consider a non-parametric test like the <em>Wilcoxon signed-rank test</em> (discussed in a later section), which does not rely on the normality assumption for the differences.</p></li>
<li><p>Proceed with caution: if the sample size is relatively large and the deviations from normality in the differences are not severe, we might proceed with the paired t-test, acknowledging the potential limitations in the interpretation of the results.</p></li>
</ul>
</section>
<section id="note-on-homoscedasticity">
<h4>Note on homoscedasticity<a class="headerlink" href="#note-on-homoscedasticity" title="Link to this heading">#</a></h4>
<p>The assumption of <em>homoscedasticity</em>, or equal variances, is crucial for the unpaired t-test, but it is not a requirement for the paired t-test.</p>
<p>The paired t-test focuses on the differences between paired observations. It inherently assumes that these <em>differences have a constant variance</em>. There’s no need to test for equal variances between the two original groups, as the test operates on a single set of differences.</p>
</section>
</section>
</section>
<section id="assessing-the-significance-of-paired-difference-mean-with-t-test">
<h2>Assessing the significance of paired difference mean with t-test<a class="headerlink" href="#assessing-the-significance-of-paired-difference-mean-with-t-test" title="Link to this heading">#</a></h2>
<p>The central question in many research studies involving paired data is whether an intervention, treatment, or the passage of time leads to a meaningful change <em>within</em> the same group or individuals. In this section, we’ll explore how the paired t-test enables us to answer this question by comparing the means of paired observations, effectively assessing the significance of the average change or difference.</p>
<section id="the-t-ratio">
<h3>The t-ratio<a class="headerlink" href="#the-t-ratio" title="Link to this heading">#</a></h3>
<p>At the core of the paired t-test also lies the <strong>t-ratio</strong> (or t-value, or t-score), and abbreviated <strong>t</strong>, a key statistic that quantifies the <em>magnitude of the average difference between paired observations relative to the variability of those differences</em>. The t-ratio used in the paired t-test shares a conceptual resemblance to both the t-statistic used in confidence intervals for a single mean and the t-ratio used in the unpaired t-test. All three involve a ratio of a difference (or an estimated parameter) to a measure of variability, and they follow a t-distribution. However, the t-ratio in the paired t-test specifically focuses on assessing the mean difference <em>within</em> the same group or individuals under different conditions, while the t-statistic for confidence intervals estimates a single population mean, and the t-ratio in the unpaired t-test compares the means of two independent groups.</p>
<section id="manual-calculation">
<h4>Manual calculation<a class="headerlink" href="#manual-calculation" title="Link to this heading">#</a></h4>
<p>In this subsection, we’ll delve into the mathematical underpinnings of the t-ratio in the context of the paired t-test, exploring how it incorporates the mean difference, the standard deviation of the differences, and the sample size to provide a standardized measure of the effect. Understanding the t-ratio is crucial for interpreting the results of the paired t-test and drawing meaningful conclusions about the statistical significance of any observed changes within the paired data.</p>
<p>In the paired t-test, we don’t need to worry about unequal variances between two separate groups. Instead, we focus on the variance of the <em>differences</em> between the paired observations.</p>
<p>The t-ratio for the paired t-test is calculated as follows:</p>
<div class="math notranslate nohighlight">
\[t = \frac{\overline{D}}{\sqrt{\frac{s_D^2}{n}}}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\overline{D}\)</span> is the mean of the differences between the paired observations <span class="math notranslate nohighlight">\(D_i = X_{1i} - X_{2i}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(s_D^2\)</span> is the variance of the differences</p></li>
<li><p><span class="math notranslate nohighlight">\(n\)</span> is the number of pairs (or the sample size)</p></li>
</ul>
<p>The standard error of the mean difference, denoted by <span class="math notranslate nohighlight">\(s_{\overline{D}}\)</span>, is calculated as:</p>
<div class="math notranslate nohighlight">
\[s_{\overline{D}} = \frac{s_D}{\sqrt{n}}\]</div>
<p>This standard error quantifies the uncertainty in our estimate of the mean difference.</p>
<p>We can then express the t-ratio as:</p>
<div class="math notranslate nohighlight">
\[t = \frac{\overline{D}}{s_{\bar D}}\]</div>
<p>The degrees of freedom for this t-statistic are simply:</p>
<div class="math notranslate nohighlight">
\[\mathrm{DF} = n - 1\]</div>
<p>where <span class="math notranslate nohighlight">\(n\)</span> is the number of pairs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the standard error of the mean difference with se²=s²/n</span>
<span class="n">se_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">variance</span> <span class="o">/</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">nobs</span><span class="p">)</span><span class="o">**</span><span class="mf">.5</span>

<span class="c1"># Calculate the t-statistic for the paired t-test</span>
<span class="n">t_statistic_paired</span> <span class="o">=</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span> <span class="o">/</span> <span class="n">se_diff</span>

<span class="c1"># Calculate the degrees of freedom</span>
<span class="n">df_paired</span> <span class="o">=</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">nobs</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t-statistic (paired) = </span><span class="si">{</span><span class="n">t_statistic_paired</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">df_paired</span><span class="si">}</span><span class="s2"> degrees of freedom&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>t-statistic (paired) = 2.14799 with 14 degrees of freedom
</pre></div>
</div>
</div>
</div>
</section>
<section id="p-value">
<h4>P value<a class="headerlink" href="#p-value" title="Link to this heading">#</a></h4>
<p>Now that we have our t-statistic and degrees of freedom, we can determine the <strong>P value</strong> associated with our test, as well as construct a <strong>confidence interval</strong> for the true mean difference in the population. The P value will quantify the probability of observing a t-statistic as extreme as (or more extreme than) the one we calculated, assuming the null hypothesis of no difference between the paired observations is true. We will utilize the cumulative distribution function (CDF) of the t-distribution to compute this probability. The confidence interval will provide a range of plausible values for the true mean difference, giving us a sense of the magnitude of the effect and the uncertainty associated with our estimate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the P value using the t-distribution (two-sided test)</span>
<span class="n">p_value_paired</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t_statistic_paired</span><span class="p">),</span> <span class="n">df_paired</span><span class="p">))</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P value for the paired t-test = </span><span class="si">{</span><span class="n">p_value_paired</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>P value for the paired t-test = 0.04970
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-the-test-results">
<h4>Visualizing the test results<a class="headerlink" href="#visualizing-the-test-results" title="Link to this heading">#</a></h4>
<p>To gain a deeper understanding of the results of the paired t-test, let’s visualize the t-statistic, the critical t-values that define the rejection regions, and the areas under the t-distribution corresponding to the P value. This visual representation will help us grasp the statistical significance of the observed mean difference and the role of the degrees of freedom in shaping the t-distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Significance level (alpha)</span>
<span class="n">α</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="c1"># Calculate critical t-values (two-tailed test)</span>
<span class="n">t_crit_lower</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">α</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">df_paired</span><span class="p">)</span> 
<span class="n">t_crit_upper</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">α</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">df_paired</span><span class="p">)</span> 

<span class="c1"># Generate x values for plotting</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">hx</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df_paired</span><span class="p">)</span>

<span class="c1"># Create the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="c1"># Plot the critical t-values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">t_crit_lower</span><span class="p">,</span> <span class="c1"># type: ignore</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">t_crit_upper</span><span class="p">,</span> <span class="c1"># type: ignore</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;t* (</span><span class="si">{</span><span class="n">t_crit_upper</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Shade the rejection regions (alpha)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">t_crit_lower</span><span class="p">],</span>
    <span class="n">hx</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">t_crit_lower</span><span class="p">],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tomato&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;α (</span><span class="si">{</span><span class="n">α</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">t_crit_upper</span><span class="p">],</span>
    <span class="n">hx</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">t_crit_upper</span><span class="p">],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tomato&#39;</span><span class="p">)</span>

<span class="c1"># Plot the observed t-statistic</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">t_statistic_paired</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;t (</span><span class="si">{</span><span class="n">t_statistic_paired</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Shade the P-value areas (two-tailed)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">t_statistic_paired</span><span class="p">)],</span>
    <span class="n">hx</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">t_statistic_paired</span><span class="p">)],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;greenyellow&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;P (</span><span class="si">{</span><span class="n">p_value_paired</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t_statistic_paired</span><span class="p">)],</span>
    <span class="n">hx</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t_statistic_paired</span><span class="p">)],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;greenyellow&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t-distribution (DF=</span><span class="si">{</span><span class="n">df_paired</span><span class="si">}</span><span class="s2">) | Paired t-test, two-tailed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/00c5ed0a7fa42fd9fdd9db97d8faa14c3df6ef35c599d325f7e258852ab367ab.png" src="_images/00c5ed0a7fa42fd9fdd9db97d8faa14c3df6ef35c599d325f7e258852ab367ab.png" />
</div>
</div>
<p>The red dashed lines in this diagram represent the critical t-values that define the <em>rejection regions</em> for a two-tailed paired t-test at a 5% significance level. The ‘tails’ of the curve outside these lines each represent 2.5% of the probability distribution under the null hypothesis (that the true population mean <em>difference</em> is zero).</p>
<p>The green dot-dashed line represents the observed t-statistic calculated from our sample data. The P value corresponds to the total probability of observing a t-statistic as extreme as (or more extreme than) the one we calculated, assuming the null hypothesis is true. In a two-tailed test like this, we consider <em>both tails of the distribution</em> because the true population mean <em>difference</em> could be either higher or lower than zero. One-tailed tests are used when we have a directional hypothesis, specifically testing if the <em>difference</em> is ‘less than zero’ or ‘greater than zero’.</p>
</section>
<section id="confidence-interval">
<h4>Confidence interval<a class="headerlink" href="#confidence-interval" title="Link to this heading">#</a></h4>
<p>A confidence interval provides a range of plausible values for the true difference in population means when comparing two paired groups. It gives us an idea of the <em>precision</em> of our estimate of this difference.</p>
<p>Since we’re dealing with paired data, we’ll use the differences between the paired observations to calculate the confidence interval. Here’s how it’s done:</p>
<ol class="arabic simple">
<li><p>Calculate the differences: for each pair of observations, calculate the difference <span class="math notranslate nohighlight">\(D_i = X_{1i} - X_{2i}\)</span></p></li>
<li><p>Calculate the mean difference: calculate the mean of these differences <span class="math notranslate nohighlight">\(\overline{D}\)</span>. This is the point estimate of the true difference in population means</p></li>
<li><p>Calculate the standard deviation of the differences: calculate the standard deviation of the differences <span class="math notranslate nohighlight">\(s_D\)</span></p></li>
<li><p>Calculate the standard error: the standard error of the mean difference for paired data is calculated as <span class="math notranslate nohighlight">\(s_D / \sqrt{n}\)</span>, where <span class="math notranslate nohighlight">\(n\)</span> is the number of pairs</p></li>
<li><p>Determine the degrees of freedom: the degrees of freedom for a paired t-test are <span class="math notranslate nohighlight">\(n - 1\)</span></p></li>
<li><p>Find the critical t-value: using the desired confidence level (e.g., 95%) and the calculated degrees of freedom, find the corresponding t* from the t-distribution table</p></li>
<li><p>Calculate the margin of error (<span class="math notranslate nohighlight">\(W\)</span>): multiply the standard error by the critical t-value</p></li>
<li><p>Construct the confidence interval: subtract and add the margin of error to the mean difference to obtain the lower and upper bounds of the confidence interval: <span class="math notranslate nohighlight">\(\overline{D} \pm W\)</span></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the confidence interval (e.g., 95% confidence)</span>
<span class="n">confidence_level</span> <span class="o">=</span> <span class="mf">0.95</span>
<span class="n">margin_of_error_paired</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">confidence_level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df_paired</span><span class="p">)</span> <span class="o">*</span> <span class="n">se_diff</span>
<span class="n">ci_paired</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span> <span class="o">-</span> <span class="n">margin_of_error_paired</span><span class="p">,</span>
    <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span> <span class="o">+</span> <span class="n">margin_of_error_paired</span><span class="p">)</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paired difference mean (crossed - self) = </span><span class="si">{</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% confidence interval for the mean difference: </span><span class="se">\</span>
<span class="s2">[</span><span class="si">{</span><span class="n">ci_paired</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ci_paired</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Paired difference mean (crossed - self) = 2.617
95% confidence interval for the mean difference: [0.004, 5.229]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="performing-the-paired-t-test-in-python">
<h3>Performing the paired t-test in Python<a class="headerlink" href="#performing-the-paired-t-test-in-python" title="Link to this heading">#</a></h3>
<p>Let’s conduct the paired t-test using both the <code class="docutils literal notranslate"><span class="pre">scipy.stats</span></code> and <code class="docutils literal notranslate"><span class="pre">pingouin</span></code> libraries in Python. We’ll compare their implementations and outputs, highlighting their respective advantages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Paired t-test using SciPy looking at the \bar{x} - \bar{y} difference</span>
<span class="n">t_statistic_scipy_paired</span><span class="p">,</span> <span class="n">p_value_scipy_paired</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_rel</span><span class="p">(</span><span class="n">crossed_fertil</span><span class="p">,</span> <span class="n">self_fertil</span><span class="p">)</span>

<span class="c1"># Paired t-test using Pingouin looking at the \bar{x} - \bar{y} difference</span>
<span class="n">ttest_results_pingouin_paired</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">crossed_fertil</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">self_fertil</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Paired t-test results (SciPy):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t-statistic = </span><span class="si">{</span><span class="n">t_statistic_scipy_paired</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, P value = </span><span class="si">{</span><span class="n">p_value_scipy_paired</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Paired t-test results (Pingouin):&quot;</span><span class="p">)</span>
<span class="n">ttest_results_pingouin_paired</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Paired t-test results (SciPy):
t-statistic = 2.148, P value = 0.0497

Paired t-test results (Pingouin):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>2.147987</td>
      <td>14</td>
      <td>two-sided</td>
      <td>0.049703</td>
      <td>[0.0, 5.23]</td>
      <td>0.889908</td>
      <td>1.544</td>
      <td>0.892939</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The paired t-test yielded a t-statistic of 2.148 with an associated P value of 0.0497. This P value is slightly less than the commonly used significance level of 0.05, suggesting <em>evidence to reject the null hypothesis of no difference between the paired measurements</em>. Therefore, we conclude that there is a statistically significant difference in the measurements before and after the intervention (or between the paired conditions).</p>
<p>Furthermore, the 95% confidence interval for the mean difference is [0.004, 5.229]. This suggests that we can be 95% confident that the true population mean difference lies within this range. The fact that this interval does not include zero further supports the conclusion that there is a significant difference between the paired measurements.</p>
</section>
<section id="follow-up-analyses">
<h3>Follow-up analyses<a class="headerlink" href="#follow-up-analyses" title="Link to this heading">#</a></h3>
<p>To gain a deeper understanding of the observed effect beyond statistical significance, we’ll conduct some follow-up analyses. This will involve examining the effect size to quantify the magnitude of the difference and assessing the effectiveness of the pairing strategy employed in the experimental design.</p>
<section id="effect-size">
<h4>Effect size<a class="headerlink" href="#effect-size" title="Link to this heading">#</a></h4>
<p>While the P value from the paired t-test informs us about the statistical significance of the observed mean difference, it doesn’t reveal the <em>magnitude</em> of this difference. To gain a more comprehensive understanding of the effect, we turn to <strong>effect size</strong> measures. These statistics quantify the size of the effect in a standardized way, allowing us to gauge its practical significance and compare it across different studies or contexts.</p>
<p>In the context of paired t-tests, a common effect size measure is <strong>Cohen’s <span class="math notranslate nohighlight">\(d\)</span></strong>. It expresses the mean difference in terms of standard deviation units, providing a scale-free measure of the effect’s size. We have previously encountered the effect size statistics in the chapter on statistical power and sample size, notably in the case of <a class="reference external" href="https://sbwiecko.github.io/intuitive_biostatistics/20%20-%20Statistical%20Power%20and%20Sample%20Size.html#the-effect-size">comparison of two groups</a>.</p>
<p>While the general idea of effect size remains the same, the specific calculation of Cohen’s d for paired t-tests differs slightly, as it focuses on the standard deviation of the differences (<span class="math notranslate nohighlight">\(s_D\)</span>) between paired observations rather than the pooled standard deviation of two independent groups:</p>
<div class="math notranslate nohighlight">
\[d = \frac{\overline{D}}{s_D}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\overline{D}\)</span> represents the mean of the differences between the paired observations</p></li>
<li><p><span class="math notranslate nohighlight">\(s_D\)</span> represents the standard deviation of the differences</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate Cohen&#39;s d manually for the paired t-test</span>
<span class="n">cohens_d_manual_paired</span> <span class="o">=</span> <span class="n">differences_fert</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">differences_fert</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cohen&#39;s d (manual, paired): </span><span class="si">{</span><span class="n">cohens_d_manual_paired</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cohen&#39;s d (manual, paired): 0.555
</pre></div>
</div>
</div>
</div>
<p>Conveniently, many statistical libraries automatically report Cohen’s <span class="math notranslate nohighlight">\(d\)</span> alongside the results of the paired t-test, for example <a class="reference external" href="https://pingouin-stats.org/build/html/generated/pingouin.compute_effsize.html"><code class="docutils literal notranslate"><span class="pre">compute_effsize</span></code> function provided by the Pingouin library</a>. Note that Pingouin applies a bias correction to Cohen’s <span class="math notranslate nohighlight">\(d\)</span>, especially for smaller sample sizes. This correction adjusts for the fact that the sample standard deviation tends to slightly underestimate the population standard deviation. Your manual calculation might not include this correction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate unbiased Cohen&#39;s d using pingouin for paired t-test</span>
<span class="n">effect_size_pingouin_paired</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">compute_effsize</span><span class="p">(</span><span class="n">crossed_fertil</span><span class="p">,</span> <span class="n">self_fertil</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eftype</span><span class="o">=</span><span class="s1">&#39;Cohen&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unbiased Cohen&#39;s d (pingouin, paired): </span><span class="si">{</span><span class="n">effect_size_pingouin_paired</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unbiased Cohen&#39;s d (pingouin, paired): 0.890
</pre></div>
</div>
</div>
</div>
<p>The conventional interpretation of Cohen’s d for paired t-tests aligns with the general guidelines:</p>
<ul class="simple">
<li><p>Small effect: d ≈ 0.2</p></li>
<li><p>Medium effect: d ≈ 0.5</p></li>
<li><p>Large effect: d ≈ 0.8</p></li>
</ul>
<p>In the current example, the large Cohen’s <span class="math notranslate nohighlight">\(d\)</span> of 0.89 suggests a substantial difference between the two conditions. Encountering a high P value (0.0497) with a large effect size suggests that while there might be a substantial effect present, the <em>study lacks sufficient power</em> to confidently detect it due to the <em>small sample size</em>. This underscores the importance of considering both P values and effect sizes when interpreting research findings and highlights the need for adequate sample sizes to draw reliable conclusions.</p>
</section>
<section id="evaluating-the-effectiveness-of-pairing">
<h4>Evaluating the effectiveness of pairing<a class="headerlink" href="#evaluating-the-effectiveness-of-pairing" title="Link to this heading">#</a></h4>
<p>The paired t-test derives its power from the inherent connection or <strong>correlation</strong> between paired observations. This correlation, often arising from <em>repeated measures on the same subjects</em> or careful matching of pairs, allows the test to focus on the <em>differences</em> between the pairs, effectively reducing variability and increasing the sensitivity to detect true effects.</p>
<p>However, the success of the paired t-test hinges on the strength of this correlation. Ideally, when designing an experiment with paired samples, we aim for a <em>strong positive correlation</em> between the paired measurements, i.e., when one measurement in a pair increases, the other measurement also tends to increase (or if one decreases, the other also tends to decrease). This indicates that the pairing or matching process has been effective in controlling for extraneous factors and isolating the effect of interest.</p>
<p>In contrast, if the correlation between the paired observations is weak or absent, the paired t-test might not offer any advantage over an unpaired t-test. In fact, in some cases, the paired t-test might even have lower power due to the loss of degrees of freedom associated with the pairing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the Pearson correlation coefficient</span>
<span class="n">pearson_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">crossed_fertil</span><span class="p">,</span> <span class="n">self_fertil</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Create the scatterplot with regression line</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">crossed_fertil</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">self_fertil</span><span class="p">,</span>
    <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s1">&#39;Pearson r = </span><span class="si">{</span><span class="n">pearson_r</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Make the axes aspect ratio equal (square)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="c1"># Set plot labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Testing the effectiveness of pairing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cross-fertilized plant height (in)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Self-fertilized plant height (in)&#39;</span><span class="p">)</span>

<span class="c1"># Adjust plot limits for better visual clarity</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>  <span class="c1"># Ensure both axes have the same limits for easier comparison</span>

<span class="c1"># Add a legend with no frame</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bccbf74ceffb70328bbea2477b43ee9018e64c9b92352cebb85ab6d268853958.png" src="_images/bccbf74ceffb70328bbea2477b43ee9018e64c9b92352cebb85ab6d268853958.png" />
</div>
</div>
<p>In this dataset, the weak or absent correlation between paired observations suggests <strong>ineffective pairing</strong>, leading to high variability in the differences. This increased variability can obscure true effects, potentially resulting in a higher P value even when a substantial difference exists. Consequently, we might observe a large effect size (Cohen’s d) but fail to achieve statistical significance due to the limited sample size and the noise introduced by ineffective pairing.</p>
<p>The current scenario, i.e., a high P value coupled with a large effect size, is more likely to occur when the pairing strategy is suboptimal. The large effect size hints at a meaningful difference, but the high variability arising from ineffective pairing hinders our ability to confidently detect it, especially with a small sample.</p>
</section>
</section>
<section id="extensions-of-the-paired-t-test">
<h3>Extensions of the paired t-test<a class="headerlink" href="#extensions-of-the-paired-t-test" title="Link to this heading">#</a></h3>
<section id="one-sided-t-test">
<h4>One-sided t-test<a class="headerlink" href="#one-sided-t-test" title="Link to this heading">#</a></h4>
<p>In the context of cross-fertilization compared to self-fertilization, looking at the height variable, we can perform a <strong>one-sided paired t-test</strong> to investigate if cross-fertilization leads to a significant <em>increase</em> in plant height compared to self-fertilization.</p>
<p>Hypothesis:</p>
<ul class="simple">
<li><p>Null hypothesis (H0): the mean difference in height between cross-fertilized and self-fertilized plants is <em>less than or equal to zero</em>.</p></li>
<li><p>Alternative hypothesis (H1): the mean difference in height between cross-fertilized and self-fertilized plants is <em>greater than zero</em>.</p></li>
</ul>
<p>We choose a one-sided test because we have a specific directional hypothesis: we expect cross-fertilization to lead to <em>increased</em> height. We are not interested in the possibility that cross-fertilization might lead to a decrease in height.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">crossed_fertil</span><span class="p">,</span> <span class="n">self_fertil</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>2.147987</td>
      <td>14</td>
      <td>greater</td>
      <td>0.024851</td>
      <td>[0.47, inf]</td>
      <td>0.889908</td>
      <td>3.088</td>
      <td>0.948282</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The data suggests that cross-fertilization likely leads to taller plants than self-fertilization, and this difference is not just due to random chance.</p>
</section>
<section id="ratio-paired-t-test">
<h4>Ratio paired t-test<a class="headerlink" href="#ratio-paired-t-test" title="Link to this heading">#</a></h4>
<p>In some cases, we might be interested in comparing not just the absolute differences between paired observations, but also the <em>proportional</em> or <em>relative</em> changes. This is where the <strong>ratio paired t-test</strong> comes in. Instead of analyzing the differences directly, this test focuses on the ratios between the paired values.</p>
<p>This approach is particularly useful when:</p>
<ul class="simple">
<li><p>The magnitude of the change is expected to be related to the <em>baseline</em> value. For example, a 5% increase in heart rate might be more meaningful for someone with a low baseline heart rate than for someone with a high baseline heart rate.</p></li>
<li><p>The data are measured on a ratio scale, where a zero value represents a true absence of the quantity being measured. Examples include weight, height, or concentration levels.</p></li>
</ul>
<p>The ratio paired t-test essentially performs a paired t-test on the <strong>logarithms</strong> of the ratios between the paired observations. This transformation allows us to analyze the proportional changes while still leveraging the benefits of the paired t-test framework.</p>
<p>Consider a real-world scenario from Table 31.3 (page 312) of “Intuitive Biostatistics 4th Edition.” This example examines if a drug can boost enzyme activity in cultured cells. Five distinct cell clones were used, with both control (untreated) and treated cells tested in parallel for each clone. This paired design helps account for any natural differences between the cell clones themselves.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data</span>
<span class="n">control</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">treated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">52</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="c1"># Create a DataFrame for Pingouin&#39;s plot_paired function</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="n">control</span><span class="p">,</span> <span class="s1">&#39;treated&#39;</span><span class="p">:</span> <span class="n">treated</span><span class="p">})</span>

<span class="c1"># Add a &#39;subject&#39; column to identify each pair</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Reshape the data into long format using `pd.melt()`</span>
<span class="n">df_long</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;enzyme_activity&#39;</span><span class="p">)</span>

<span class="c1"># Create the figure with two subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Left subplot: Before-After plot with original data</span>
<span class="n">pg</span><span class="o">.</span><span class="n">plot_paired</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df_long</span><span class="p">,</span>
    <span class="n">dv</span><span class="o">=</span><span class="s2">&quot;enzyme_activity&quot;</span><span class="p">,</span>
    <span class="n">within</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span>
    <span class="n">boxplot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;zorder&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;original data&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Enzyme activity&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># Right subplot: Before-After plot with log-transformed data</span>
<span class="c1"># Apply log transformation to the &#39;enzyme_activity&#39; column</span>
<span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;log_enzyme_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;enzyme_activity&#39;</span><span class="p">])</span>

<span class="n">pg</span><span class="o">.</span><span class="n">plot_paired</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df_long</span><span class="p">,</span>
    <span class="n">dv</span><span class="o">=</span><span class="s2">&quot;log_enzyme_activity&quot;</span><span class="p">,</span>
    <span class="n">within</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span>
    <span class="n">boxplot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;zorder&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log-transformed data&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Enzyme activity ($\log$)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Before-after plots&quot;</span><span class="p">)</span>

<span class="c1"># Adjust layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>  <span class="c1"># not default in Pingouin anymore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2cbc84dd38a3375de004a54eb76d7e93cf93f803c648353bd4d5608a4f4298f4.png" src="_images/2cbc84dd38a3375de004a54eb76d7e93cf93f803c648353bd4d5608a4f4298f4.png" />
</div>
</div>
<p>A visual comparison of the before-after plots reveals a stark difference between the original and log-transformed data. In the original scale, the data points appear somewhat scattered, with the changes between control and treated conditions varying considerably depending on the baseline enzyme activity. This heterogeneity in the changes hints at a potential <em>deviation from normality</em>, which could impact the validity of a standard paired t-test.</p>
<p>However, when we examine the log-transformed data, a striking pattern emerges. The lines connecting the paired observations now exhibit a remarkably consistent slope, suggesting a proportional change in enzyme activity across different baseline levels. This visual observation aligns with the assumption of the ratio paired t-test, where we expect the changes to be proportional rather than absolute. Furthermore, the log transformation often helps normalize data, potentially making the ratio paired t-test a more suitable approach for this dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform the paired t-test on the log-transformed data</span>
<span class="c1"># Remember we are analyzing \bar{x} - \bar{y}</span>
<span class="n">ttest_results_paired</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
    <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">confidence</span><span class="o">=</span><span class="mf">.95</span><span class="p">)</span>

<span class="n">ttest_results_paired</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>11.81437</td>
      <td>4</td>
      <td>two-sided</td>
      <td>0.000294</td>
      <td>[0.21, 0.33]</td>
      <td>0.619234</td>
      <td>92.646</td>
      <td>0.189218</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This extremely low P value indicates strong evidence against the null hypothesis. In other words, we can confidently reject the idea that there is no difference in the log-transformed enzyme activity between the control and treated groups.</p>
<p>Moreover, the high positive t-value suggests a substantial difference between the log-transformed means. The positive sign indicates that the mean of the log-transformed treated group is significantly higher than the mean of the log-transformed control group.</p>
<p>Since we performed the t-test on log-transformed data, we need to interpret the results in terms of ratios or multiplicative changes rather than absolute differences.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract the mean difference and confidence interval from the Pingouin results</span>
<span class="n">mean_diff_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">control</span><span class="p">))</span>  <span class="c1"># Mean difference on the log scale</span>
<span class="n">ci_log</span> <span class="o">=</span> <span class="n">ttest_results_paired</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;T-test&#39;</span><span class="p">,</span> <span class="s1">&#39;CI95%&#39;</span><span class="p">]</span>          <span class="c1"># 95% CI on the log scale</span>

<span class="c1"># Calculate the mean ratio and its confidence interval on the original scale</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">mean_diff_log</span>
<span class="n">ci_original</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">ci_log</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">ci_log</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;On average, the treatment multiplies enzyme activity by </span><span class="si">{</span><span class="n">factor</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">with 95% CI from </span><span class="si">{</span><span class="n">ci_original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">ci_original</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>On average, the treatment multiplies enzyme activity by 1.860, with 95% CI from 1.62 to 2.14
</pre></div>
</div>
</div>
</div>
<p>A ratio of 1.86 signifies that the treated group’s enzyme activity is, on average, 1.86 times the activity in the control group. This translates to an (1.86 - 1) * 100 = 86% increase.</p>
<p>Furthermore, the confidence interval (1.62, 2.14) provides a range of plausible values for the true population mean ratio. Importantly, it doesn’t contain 1.0. Since a ratio of 1.0 would indicate no effect (treated and control groups being the same), the absence of 1.0 in the confidence interval strengthens the conclusion that the observed increase is statistically significant and unlikely due to chance.</p>
</section>
<section id="mcnemar-s-test">
<h4>McNemar’s test<a class="headerlink" href="#mcnemar-s-test" title="Link to this heading">#</a></h4>
<p>McNemar’s test, occasionally referred to as the “within-subjects chi-squared test,” is specifically designed to analyze paired data when the outcome is dichotomous or binary, meaning there are only two possible categories (e.g., yes/no, success/failure). It’s particularly useful for assessing changes in responses or preferences within the same individuals or matched pairs over time or under different conditions.</p>
<p>The McNemar test utilizes a 2x2 table to summarize paired data with a <em>binary outcome</em>. The following table represents the possible outcomes:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head text-center"><p>Outcome 2: positive</p></th>
<th class="head text-center"><p>Outcome 2: negative</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Outcome 1: positive</p></td>
<td class="text-center"><p>a</p></td>
<td class="text-center"><p>b</p></td>
</tr>
<tr class="row-odd"><td><p>Outcome 1: negative</p></td>
<td class="text-center"><p>c</p></td>
<td class="text-center"><p>d</p></td>
</tr>
</tbody>
</table>
</div>
<p>where:</p>
<ul class="simple">
<li><p>“Outcome 1” and “Outcome 2” represent the two measurement points or conditions being compared (e.g., before and after treatment, control vs. experimental group).</p></li>
<li><p>“Positive” and “Negative” represent the two possible outcomes for each measurement (e.g., success/failure, presence/absence).</p></li>
<li><p>The cells ‘a’, ‘b’, ‘c’, and ‘d’ represent the counts of pairs falling into each combination of outcomes.</p></li>
</ul>
<p>McNemar’s test focuses on the <strong>discordant pairs</strong> (‘b’ and ‘c’), where the outcome changed between the two measurements. These pairs are crucial for assessing whether there’s a statistically significant difference in the proportions of positive outcomes between the two conditions.</p>
<p>The McNemar’s test statistic, often denoted as χ² or sometimes Q, is calculated as <span class="math notranslate nohighlight">\(\chi^2 = \frac{(| b - c | - \mathrm{correction})^2}{b + c}\)</span>, where <span class="math notranslate nohighlight">\(b\)</span> and <span class="math notranslate nohighlight">\(c\)</span> represent the counts of discordant pairs, and <span class="math notranslate nohighlight">\(\mathrm{correction}\)</span> is Yates’s continuity correction, typically set to 0.5 or 1 depending on the software. The McNemar’s test statistic, under the null hypothesis, approximately follows a chi-squared distribution with one degree of freedom. However, this approximation can be less accurate for smaller sample sizes. Yates’ continuity correction is applied to improve the accuracy of this approximation by adjusting the calculated chi-squared value slightly downwards. This adjustment helps prevent the overestimation of statistical significance (i.e., finding a significant result when there isn’t one) when dealing with smaller sample sizes or low expected frequencies in the contingency table.</p>
<p>Let’s examine a case-control study exploring the connection between a risk factor (for instance, smoking) and a disease (like lung cancer). Data is gathered in pairs: each person with the disease (a “case”) is paired with someone without it (a “control”), ensuring they’re similar in age, gender, etc. The researchers examined a total of 134 cases and their corresponding controls, and the outcomes are summarized in the following table.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head text-center"><p>Cases (Risk+)</p></th>
<th class="head text-center"><p>Cases (Risk-)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Controls (Risk+)</p></td>
<td class="text-center"><p>13</p></td>
<td class="text-center"><p>4</p></td>
</tr>
<tr class="row-odd"><td><p>Controls (Risk-)</p></td>
<td class="text-center"><p>25</p></td>
<td class="text-center"><p>92</p></td>
</tr>
</tbody>
</table>
</div>
<p>The table shows the number of pairs falling into each combination of exposure status (risk factor present or absent) for cases and controls.</p>
<ul class="simple">
<li><p>The 13 pairs where both cases and controls were exposed to the risk factor, as well as the 92 pairs where neither was exposed, provide no information about the association between the risk factor and the disease. These are the <strong>concordant pairs</strong>.</p></li>
<li><p>The remaining pairs (4 and 25) are the <strong>discordant pairs</strong>, where the case and control have different exposure statuses. These pairs are crucial for assessing the association.</p></li>
</ul>
<p>This isn’t exactly a contingency table in the traditional sense. The actual contingency table would look like this:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head text-center"><p>Risk Factor +</p></th>
<th class="head text-center"><p>Risk Factor -</p></th>
<th class="head"><p>Total</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Case</p></td>
<td class="text-center"><p>38</p></td>
<td class="text-center"><p>96</p></td>
<td><p>134</p></td>
</tr>
<tr class="row-odd"><td><p>Control</p></td>
<td class="text-center"><p>17</p></td>
<td class="text-center"><p>117</p></td>
<td><p>134</p></td>
</tr>
<tr class="row-even"><td><p>Total</p></td>
<td class="text-center"><p>55</p></td>
<td class="text-center"><p>213</p></td>
<td><p>268</p></td>
</tr>
</tbody>
</table>
</div>
<p>McNemar’s test focuses on these discordant pairs to determine if there’s a statistically significant difference in the proportions of cases and controls exposed to the risk factor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">92</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Extract discordant pair counts from the contingency table</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Count of cases exposed, controls not exposed</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Count of cases not exposed, controls exposed</span>

<span class="c1"># Calculate the McNemar test statistic with Yates&#39; continuity correction</span>
<span class="n">mcnemar_statistic</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>

<span class="c1"># Print the calculated statistic</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;McNemar&#39;s statistic:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mcnemar_statistic</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>McNemar&#39;s statistic: 13.793
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>

<span class="c1"># Significance level (alpha)</span>
<span class="n">α</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="c1"># Calculate critical chi-squared value</span>
<span class="n">chi2_crit</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">α</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 1 degree of freedom</span>

<span class="c1"># Generate x values for plotting</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Adjust range as needed</span>
<span class="n">hx</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Chi-squared PDF with 1 degree of freedom</span>

<span class="c1"># Create the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="c1"># Plot the critical chi-squared value</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">chi2_crit</span><span class="p">,</span> <span class="c1"># type: ignore</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;χ²* (</span><span class="si">{</span><span class="n">chi2_crit</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Shade the rejection region (alpha)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">chi2_crit</span><span class="p">],</span>
    <span class="n">hx</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">chi2_crit</span><span class="p">],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tomato&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;α (</span><span class="si">{</span><span class="n">α</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Plot the observed chi-squared statistic</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">mcnemar_statistic</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;M² (</span><span class="si">{</span><span class="n">mcnemar_statistic</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Shade the P-value area</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">mcnemar_statistic</span><span class="p">],</span>
    <span class="n">hx</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">mcnemar_statistic</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;greenyellow&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;P (</span><span class="si">{</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">mcnemar_statistic</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">)&#39;</span>  <span class="c1"># Calculate P value</span>
<span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;χ²&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;χ² distribution (DF=1) | McNemar&#39;s test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d0edcedf31398f36d81bd674300b41f4f8d7dd2f6b1cb2bd4b1f815d92806f7d.png" src="_images/d0edcedf31398f36d81bd674300b41f4f8d7dd2f6b1cb2bd4b1f815d92806f7d.png" />
</div>
</div>
<p>We can easily conduct McNemar’s test using either the free web calculator available in the <a class="reference external" href="https://www.graphpad.com/quickcalcs/mcNemar1/">QuickCalcs section of graphpad.com</a> or by utilizing the <a class="reference external" href="https://www.statsmodels.org/dev/generated/statsmodels.stats.contingency_tables.mcnemar.html"><code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> library in Python</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.stats.contingency_tables</span> <span class="kn">import</span> <span class="n">mcnemar</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mcnemar</span><span class="p">(</span>
    <span class="n">table</span><span class="p">,</span>
    <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># exact=False uses the chi-square distribution instead of binomial distribution</span>
    <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pvalue      0.00020408400998040742
statistic   13.793103448275861
</pre></div>
</div>
</div>
</div>
<p>In this specific case, the χ² value is 13.79 with one degree of freedom. This results in a two-tailed P value of 0.0002. In simpler terms, if there was truly no link between the risk factor and the disease, the chance of observing an odds ratio this far from 1.0 (indicating no association) is merely 0.02 percent.</p>
<p>Instead of getting caught up in the complexities of the chi-square approximation and whether or not to apply Yates’ correction (and which version to use), it is suggested opting for the binomial test. This provides an exact result, eliminating the need for such approximations and corrections.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">mcnemar</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pvalue      0.00010371580719947815
statistic   4.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="bayesian-approach">
<h4>Bayesian approach<a class="headerlink" href="#bayesian-approach" title="Link to this heading">#</a></h4>
<p>In contrast to frequentist statistics, which focuses on the probability of observing data given a fixed hypothesis (P values), the Bayesian approach calculates the probability of a hypothesis being true given the observed data. This is achieved by combining prior knowledge (represented by a prior distribution) with the likelihood of the data to obtain a posterior distribution, which reflects our updated belief about the hypothesis after observing the data.</p>
<p>We previously introduced the Bayesian approach in the chapter on confidence intervals, where we focused on estimating a single population mean.
In the context of the paired t-test, a Bayesian approach would estimate the probability distribution of the true mean difference, allowing us to make statements like “There’s a 95% probability that the true mean difference lies between these two values.”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform Bayesian estimation of the mean difference</span>
<span class="n">bayes_result</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">bayes_mvs</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># Extract and print the results</span>
<span class="n">posterior_mean</span> <span class="o">=</span> <span class="n">bayes_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">credible_interval</span> <span class="o">=</span> <span class="n">bayes_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bayesian estimate of the mean difference: </span><span class="si">{</span><span class="n">posterior_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% credible interval for the mean difference: </span><span class="se">\</span>
<span class="s2">[</span><span class="si">{</span><span class="n">credible_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">credible_interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bayesian estimate of the mean difference: 2.617
95% credible interval for the mean difference: [0.004, 5.229]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In fact many more information can be accessed</span>
<span class="n">bayes_result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(Mean(statistic=2.6166666666666667, minmax=(0.00389916480019048, 5.2294341685331425)),
 Variance(statistic=25.969965277777774, minmax=(11.931551867861122, 55.36591719484016)),
 Std_dev(statistic=4.991122961308315, minmax=(3.45420784954541, 7.440827722427134)))
</pre></div>
</div>
</div>
</div>
<p>While this brief introduction provides a glimpse into the Bayesian perspective on paired t-tests, it’s important to recognize that Bayesian statistics is a vast and nuanced field. The choice of prior distributions, model selection, and computational techniques can significantly influence the results and interpretation of Bayesian analyses. Delving deeper into the intricacies of Bayesian inference would require a dedicated text, beyond the scope of this introductory chapter. However, for those intrigued by the potential of Bayesian methods, we encourage further exploration of this powerful statistical framework.</p>
</section>
</section>
</section>
<section id="non-parametric-approach">
<h2>Non-parametric approach<a class="headerlink" href="#non-parametric-approach" title="Link to this heading">#</a></h2>
<p>In the previous chapter on unpaired t-tests, we explored both parametric and non-parametric methods for comparing the means of two independent groups. We noted that parametric tests, like the t-test and ANOVA, are robust to minor deviations from normality, especially with large samples. However, when the assumptions of normality are violated, non-parametric methods offer valuable alternatives. These methods typically analyze the ranks of the data, making them less sensitive to outliers and deviations from normality. However, it’s important to remember that non-parametric tests might have lower statistical power compared to parametric tests when the data is truly Gaussian.</p>
<p>As a reminder, the follwoing flowchart was designed to help choosing between <a class="reference external" href="https://pingouin-stats.org/build/html/guidelines.html#non-parametric">Pingouin’s functions adequate for a non-parametric analysis</a>:</p>
<p><img alt="selection of the nonparamettric method" src="https://pingouin-stats.org/build/html/_images/flowchart_nonparametric.svg" /></p>
<section id="performing-the-wilcoxon-signed-rand-test-manually">
<h3>Performing the Wilcoxon signed-rand test manually<a class="headerlink" href="#performing-the-wilcoxon-signed-rand-test-manually" title="Link to this heading">#</a></h3>
<section id="exact-test">
<h4>Exact test<a class="headerlink" href="#exact-test" title="Link to this heading">#</a></h4>
<p>The <strong>Wilcoxon matched-pairs signed-rank test</strong> assesses the null hypothesis that two related paired samples come from the same distribution. It specifically tests whether the distribution of the differences (x - y) is symmetric about zero. In simpler terms, it checks if the differences between matched pairs are equally likely to be positive or negative. Its underlying principle is to consider both the magnitude and direction of the differences between paired observations:</p>
<div class="math notranslate nohighlight">
\[W = \sum_{i=1}^{N} [\operatorname{sgn}(x_{2,i} - x_{1,i}) R_i]\]</div>
<p>where <span class="math notranslate nohighlight">\(x_i = (x_{1,i}, x_{2,i})\)</span> represents the <span class="math notranslate nohighlight">\(i\)</span>-th pair of measurements, and <span class="math notranslate nohighlight">\(R_i\)</span> is the rank of the absolute difference <span class="math notranslate nohighlight">\(|x_{2,i} - x_{1,i}|\)</span>.</p>
<p>The test works as follows:</p>
<ol class="arabic simple">
<li><p>Calculate the difference between each matched pair (e.g., ‘after - before’ or ‘treatment - control’) and note the sign of the difference, e.g., negative values refer to a decrease</p></li>
<li><p>Rank the absolute values of the differences, temporarily <em>ignoring whether they are positive or negative</em></p></li>
<li><p>Sum the ranks of the positive differences and the ranks of the negative differences separately</p></li>
<li><p>Compute the test statistic W as the minimum between the two sums of ranks obtained in the previous step</p></li>
<li><p>Compute the P value: it represents the probability of observing a test statistic (in this case, the difference between the sums of ranks) as extreme as, or more extreme than, the one calculated from the data, assuming the <em>null hypothesis</em> is true. However, the specific way to compute this P value depends on the sample size and whether we’re using tables, the normal approximation, or exact methods, as discussed in the previous chapter for the Mann-Whitney U test</p></li>
</ol>
<p>Pairs with large absolute differences have higher ranks, contributing more to W, while pairs with small differences have less influence. By focusing on ranks, the test is less sensitive to outliers and primarily detects shifts in median values between the two groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">rankdata</span>

<span class="c1"># Make an array copy of the differences_fert Series</span>
<span class="n">differences_array</span> <span class="o">=</span> <span class="n">differences_fert</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># Extract the signs of the differences</span>
<span class="n">signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">differences_array</span><span class="p">)</span>  <span class="c1"># 1 for positive, -1 for negative, 0 for zero</span>

<span class="c1"># Print the differences and their signs</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Differences:&quot;</span><span class="p">,</span> <span class="n">differences_array</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Signs:&quot;</span><span class="p">,</span> <span class="n">signs</span><span class="p">)</span>

<span class="c1"># Calculate ranks of absolute differences</span>
<span class="n">ranks_abs_diff</span> <span class="o">=</span> <span class="n">rankdata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">differences_array</span><span class="p">))</span>

<span class="c1"># Print the ranks with a descriptive message</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ranks of the absolute differences:&quot;</span><span class="p">,</span> <span class="n">ranks_abs_diff</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Differences: [ 6.125 -8.375  1.     2.     0.75   2.875  3.5    5.125  1.75   3.625
  7.     3.     9.375  7.5   -6.   ]
Signs: [ 1. -1.  1.  1.  1.  1.  1.  1.  1.  1.  1.  1.  1.  1. -1.]
Ranks of the absolute differences:
[11. 14.  2.  4.  1.  5.  7.  9.  3.  8. 12.  6. 15. 13. 10.]
</pre></div>
</div>
</div>
</div>
<p>It’s crucial to address two potential issues that can arise:</p>
<ul class="simple">
<li><p><strong>Ties:</strong> ties occur when two or more pairs have the same difference. The Wilcoxon test assigns the <em>average</em> rank to tied values. While this is a reasonable approach, a large number of ties can reduce the test’s expressiveness, making it less sensitive to subtle differences between the groups.</p></li>
<li><p><strong>Zeros:</strong> zeros represent pairs with no difference between the measurements. These pairs don’t provide information about whether the distribution of differences is centered around zero, which is the null hypothesis of the test. Consequently, the Wilcoxon test typically <em>discards</em> pairs with zero differences. If a substantial proportion of pairs have zero differences, the test’s power can be significantly reduced.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the sum of ranks for positive and negative differences</span>
<span class="n">W_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ranks_abs_diff</span><span class="p">[</span><span class="n">differences_fert</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">W_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ranks_abs_diff</span><span class="p">[</span><span class="n">differences_fert</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span>

<span class="c1"># Print the results with clear labels</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of ranks for positive differences (W+) = </span><span class="si">{</span><span class="n">W_pos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of ranks for negative differences (W-) = </span><span class="si">{</span><span class="n">W_neg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Compute the W-statistic as the minimum of W_pos and W_neg</span>
<span class="n">W_statistic</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">W_pos</span><span class="p">,</span> <span class="n">W_neg</span><span class="p">)</span>  <span class="c1"># Corrected calculation</span>

<span class="c1"># Print the result</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;W-statistic: </span><span class="si">{</span><span class="n">W_statistic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sum of ranks for positive differences (W+) = 96.0
Sum of ranks for negative differences (W-) = 24.0
W-statistic: 24.0
</pre></div>
</div>
</div>
</div>
<p>To determine the P value for the Wilcoxon signed-rank test, we can consult <a class="reference external" href="https://real-statistics.com/statistics-tables/wilcoxon-signed-ranks-table/">tables of critical values</a>. These tables provide P values associated with different values of the test statistic W for various sample sizes. Most tables offer both one-sided and two-sided P values. If only one-sided P values are available, we can double them to obtain the two-sided P value.</p>
<p>The critical value is the threshold that W must exceed to reject the null hypothesis at a given significance level (α). If the calculated W statistic is slightly lower than the critical value W*, the P value should be approximately equal to the chosen alpha, e.g., P ≈ 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print the critical value and the calculated W-statistic</span>
<span class="n">W_critical</span> <span class="o">=</span> <span class="mi">25</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Critical W = </span><span class="si">{</span><span class="n">W_critical</span><span class="si">}</span><span class="s2"> for alpha = 0.05 and n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated W-statistic = </span><span class="si">{</span><span class="n">W_statistic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Compare the W-statistic to the critical value and draw a conclusion</span>
<span class="k">if</span> <span class="n">W_statistic</span> <span class="o">&lt;=</span> <span class="n">W_critical</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reject the null hypothesis. There is a significant difference between the groups.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fail to reject the null hypothesis. There is no significant difference between the groups.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Critical W = 25 for alpha = 0.05 and n = 15
Calculated W-statistic = 24.0
Reject the null hypothesis. There is a significant difference between the groups.
</pre></div>
</div>
</div>
</div>
<p>Calculating the <em>exact null distribution</em> for the Wilcoxon signed-rank test involves more intricate combinatorial calculations compared to the Mann-Whitney U test discussed previously. While we won’t delve into the specific details here, it’s important to be aware of the computational challenges involved, especially for larger sample sizes.</p>
</section>
<section id="asymptotic-approach">
<h4>Asymptotic approach<a class="headerlink" href="#asymptotic-approach" title="Link to this heading">#</a></h4>
<p>When both sample sizes are 10 or greater, we can approximate the distribution of W as a normal distribution with mean <span class="math notranslate nohighlight">\(\mu_A\)</span> and standard deviation <span class="math notranslate nohighlight">\(\sigma_A\)</span>. This normal approximation simplifies the calculation of P values and is often used in statistical software.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">nobs</span>

<span class="c1"># Significance level (alpha)</span>
<span class="n">α</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="c1"># Determine the mean and standard deviation for the normal approximation</span>
<span class="n">μ</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
<span class="n">σ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>

<span class="c1"># Generate x values for plotting the normal distribution</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">μ</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">σ</span> <span class="p">,</span> <span class="n">μ</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">σ</span> <span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">normal_pdf</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">σ</span> <span class="p">)</span>

<span class="c1"># Create the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">normal_pdf</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="c1"># Plot the critical W-values (two-tailed test)</span>
<span class="n">W_crit_lower</span> <span class="o">=</span> <span class="n">μ</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">α</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">σ</span>   <span class="c1"># Lower critical W</span>
<span class="n">W_crit_upper</span> <span class="o">=</span> <span class="n">μ</span> <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">α</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">σ</span>   <span class="c1"># Upper critical W</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">W_crit_lower</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">W_crit_upper</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;W* (</span><span class="si">{</span><span class="n">W_crit_lower</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="p">)</span>

<span class="c1"># Shade the rejection regions (alpha)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">normal_pdf</span><span class="p">,</span>
    <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">W_crit_lower</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">W_crit_upper</span><span class="p">),</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tomato&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;α (</span><span class="si">{</span><span class="n">α</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="p">)</span>

<span class="c1"># Calculate the z-score</span>
<span class="n">W_crit</span> <span class="o">=</span> <span class="p">(</span><span class="n">W_statistic</span> <span class="o">-</span> <span class="n">μ</span><span class="p">)</span> <span class="o">/</span> <span class="n">σ</span>

<span class="c1"># Calculate the p-value (two-tailed)</span>
<span class="n">p_value_W</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_crit</span><span class="p">)))</span>

<span class="c1"># Plot the observed W-statistic</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">W_statistic</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;W (</span><span class="si">{</span><span class="n">W_statistic</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="p">)</span>

<span class="c1"># Shade the P-value areas (two-tailed)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">normal_pdf</span><span class="p">,</span>
    <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">W_statistic</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">μ</span> <span class="o">+</span> <span class="p">(</span><span class="n">μ</span> <span class="o">-</span> <span class="n">W_statistic</span><span class="p">)),</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;greenyellow&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;P (</span><span class="si">{</span><span class="n">p_value_W</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normal approximation to W distribution (n=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/350228a72c31ddf49e4d2d9eecef44586d1ca22ecbd77ae93f902ab1f7fe09ba.png" src="_images/350228a72c31ddf49e4d2d9eecef44586d1ca22ecbd77ae93f902ab1f7fe09ba.png" />
</div>
</div>
</section>
</section>
<section id="python-tools-for-the-non-parametric-paired-t-test">
<h3>Python tools for the non-parametric paired t-test<a class="headerlink" href="#python-tools-for-the-non-parametric-paired-t-test" title="Link to this heading">#</a></h3>
<p>Python offers convenient tools for running the Wilcoxon signed-rank test, simplifying analysis and providing additional functionalities.</p>
<p>SciPy provides a comprehensive collection of statistical functions, including the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.wilcoxon.html"><code class="docutils literal notranslate"><span class="pre">wilcoxon</span></code> function</a> for performing the Wilcoxon signed-rank test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">wilcoxon</span>

<span class="c1"># Perform Wilcoxon signed-rank test with exact p-value calculation</span>
<span class="n">W_statistic_exact</span><span class="p">,</span> <span class="n">p_value_exact</span> <span class="o">=</span> <span class="n">wilcoxon</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>

<span class="c1"># Perform Wilcoxon signed-rank test with normal approximation p-value calculation</span>
<span class="n">W_statistic_asymptotic</span><span class="p">,</span> <span class="n">p_value_asymptotic</span> <span class="o">=</span> <span class="n">wilcoxon</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;approx&#39;</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wilcoxon signed-rank test results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Exact P value: </span><span class="si">{</span><span class="n">p_value_exact</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Asymptotic P value (similar to normal distribution method): </span><span class="si">{</span><span class="n">p_value_asymptotic</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wilcoxon signed-rank test results:
  Exact P value: 0.04126
  Asymptotic P value (similar to normal distribution method): 0.04089
</pre></div>
</div>
</div>
</div>
<p>While SciPy provides the core functionality for the Mann-Whitney U test, Pingouin offers a more streamlined <a class="reference external" href="https://pingouin-stats.org/build/html/generated/pingouin.wilcoxon.html">function <code class="docutils literal notranslate"><span class="pre">wilcoxon</span></code></a> with additional features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform Wilcoxon signed-rank test using Pingouin</span>
<span class="n">pg</span><span class="o">.</span><span class="n">wilcoxon</span><span class="p">(</span>
    <span class="n">differences_fert</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;approx&#39;</span><span class="p">,</span>
    <span class="n">correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Pingouin applies a continuity correction by default</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W-val</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>RBC</th>
      <th>CLES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Wilcoxon</th>
      <td>24.0</td>
      <td>two-sided</td>
      <td>0.040888</td>
      <td>0.6</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>When the P value is less than 0.05 in a two-tailed Wilcoxon signed-rank test, we generally conclude that there is a significant difference between the paired groups being compared. However, in our case, the P value is borderline, as seen with the parametric tests. The calculated W (24) is slightly lower than the critical value (25), suggesting that the P value is close to the significance level of 0.05. While we still reject the null hypothesis, it’s important to acknowledge the borderline nature of this result and consider the possibility of a type I error (false positive).</p>
</section>
</section>
<section id="bootstrapping-and-permutation-tests-for-paired-data">
<h2>Bootstrapping and permutation tests for paired data<a class="headerlink" href="#bootstrapping-and-permutation-tests-for-paired-data" title="Link to this heading">#</a></h2>
<p><strong>Bootstrapping</strong> offers a robust alternative for statistical inference, particularly useful when dealing with small sample sizes or when the assumptions of traditional parametric tests might not be fully met. Bootstrapping allows us to estimate parameters and confidence intervals directly from the data itself, without relying on strong assumptions about the underlying population distribution. This approach, known as <strong>non-parametric inference</strong>, was previously encountered in the chapter on calculating the confidence interval of a mean (univariate), as well as in the chapter on comparing two means with unpaired t test.</p>
<p>While bootstrapping is primarily used for estimation, <strong>permutation tests</strong>, another resampling-based method, are specifically designed for <em>hypothesis testing</em>. They can be employed to test various hypotheses, such as the null hypothesis of exchangeability (where group labels are irrelevant) or the hypothesis of equal means after shifting the group means to a common value.</p>
<p>Recent research has explored the application of bootstrap and permutation methods to <em>paired data</em>, particularly when the distributions of the paired differences might deviate from normality. A <a class="reference external" href="https://link.springer.com/article/10.1007/s11222-012-9370-4">study by Konietschke and Pauly (2014)</a> demonstrated that even when the data may not be perfectly exchangeable under the null hypothesis, certain permutation and bootstrap approaches can provide valid and powerful alternatives to the traditional t-test. These methods, which may involve resampling or permuting the data while accounting for the dependency structure within pairs, have been shown to improve the power of the test under conditions of non-normality. This highlights the potential of bootstrap and permutation methods to provide more robust and reliable inferences in situations where the assumptions of the paired t-test might be violated.</p>
<section id="generating-bootstrap-pair-samples">
<h3>Generating bootstrap pair samples<a class="headerlink" href="#generating-bootstrap-pair-samples" title="Link to this heading">#</a></h3>
<p>The core idea behind bootstrapping remains the same as for unpaired observations: treat our observed sample as a miniature representation of the population. However, in the context of paired data, we resample the <em>pairs</em> of observations, preserving the crucial relationship between the two measurements within each pair. We repeatedly resample (with replacement) from our original set of pairs to create multiple bootstrap samples. Each replicate is a new dataset of the same size, but now consisting of these resampled pairs.</p>
<p>For each bootstrap sample, we calculate the statistic of interest, i.e., in this case, the mean difference between the <em>paired measurements</em>. This generates a <strong>bootstrap distribution</strong> of paired differences mean, which serves as an approximation of how this statistic would vary if we were to repeatedly sample pairs from the population.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set random seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="c1"># Generate 10000 bootstrap replicates of the mean difference</span>
<span class="n">n_replicates</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">bs_differences_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">differences_fert</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">),</span>
            <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicates</span><span class="p">)</span>
    <span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">bs_differences_means</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>  <span class="c1"># print the 6 first replicates</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[3.41666667 3.40833333 3.375      0.775      1.80833333 3.65      ]
</pre></div>
</div>
</div>
</div>
</section>
<section id="estimate-of-the-confidence-interval-for-the-paired-difference-mean">
<h3>Estimate of the confidence interval for the paired difference mean<a class="headerlink" href="#estimate-of-the-confidence-interval-for-the-paired-difference-mean" title="Link to this heading">#</a></h3>
<p>Once we have the bootstrap distribution of the <em>paired difference means</em>, we can estimate the confidence interval by finding the percentiles corresponding to the desired confidence level.</p>
<p>For a 95% confidence interval, we typically use the 2.5th and 97.5th percentiles of the bootstrap distribution of the difference means. This means that 95% of the bootstrap estimates of the paired difference mean fall within this interval, providing a range of plausible values for the true population mean difference.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the 95% CI and the standard error</span>
<span class="n">bs_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_differences_means</span><span class="p">)</span>
<span class="n">bs_CI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bs_differences_means</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">bs_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bs_differences_means</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bootstrap estimate of the mean of the paired differences= </span><span class="si">{</span><span class="n">bs_m</span><span class="si">:</span><span class="s2">5.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% bootstrap percentile CI = </span><span class="si">{</span><span class="n">bs_CI</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bootstrap standard error = </span><span class="si">{</span><span class="n">bs_s</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrap estimate of the mean of the paired differences=  2.63
95% bootstrap percentile CI = [0.16 4.76]
Bootstrap standard error = 1.17700
</pre></div>
</div>
</div>
</div>
<p>It’s generally expected that the confidence interval obtained through bootstrapping, here [0.16, 4.76], will be reasonably similar to the confidence interval calculated using the t-distribution (here [0.004, 5.229]), especially when the sample size is sufficiently large and the underlying assumptions of the paired t-test are met.</p>
<p>Interestingly, in this case, the confidence interval obtained through bootstrapping is narrower than the one derived from the t-distribution. This might seem counterintuitive, as we generally expect wider confidence intervals with smaller sample sizes due to increased uncertainty. However, bootstrapping can be less sensitive to violations of the normality assumption (which the paired t-test relies on), potentially leading to a narrower interval when the distribution of the paired differences deviates from normality.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the histogram of the bootstrap distribution of mean paired differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">bs_differences_means</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bootstrap mean difference&#39;</span><span class="p">)</span>

<span class="c1"># Annotate the observed mean difference</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Observed mean difference (</span><span class="si">{</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Add lines for the confidence interval</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">bs_CI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;2.5th (</span><span class="si">{</span><span class="n">bs_CI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">bs_CI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;97.5th (</span><span class="si">{</span><span class="n">bs_CI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mean difference&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bootstrap distribution of the mean difference (B=</span><span class="si">{</span><span class="n">n_replicates</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b067779a0a584a022b1ac440509852537c7a1539ba75f6d119c7ca81f17f50d3.png" src="_images/b067779a0a584a022b1ac440509852537c7a1539ba75f6d119c7ca81f17f50d3.png" />
</div>
</div>
<p>Given the symmetrical distribution of our bootstrapped mean paired differences, we can also estimate the confidence interval using the normal approximation and the previously calculated bootstrap standard error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the 95% normal margin of error</span>
<span class="n">z_crit</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span>
<span class="n">bs_w</span> <span class="o">=</span>  <span class="n">z_crit</span> <span class="o">*</span> <span class="n">bs_s</span>

<span class="c1"># Calculate confidence interval</span>
<span class="n">bs_ci_normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">bs_m</span> <span class="o">-</span> <span class="n">bs_w</span><span class="p">,</span> <span class="n">bs_m</span> <span class="o">+</span> <span class="n">bs_w</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># Print the result</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% normal percentile CI of bootstrap distribution = </span><span class="si">{</span><span class="n">bs_ci_normal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>95% normal percentile CI of bootstrap distribution = [0.3267  4.94045]
</pre></div>
</div>
</div>
</div>
</section>
<section id="bootstrapping-with-pingouin">
<h3>Bootstrapping with Pingouin<a class="headerlink" href="#bootstrapping-with-pingouin" title="Link to this heading">#</a></h3>
<p>The <a class="reference external" href="https://pingouin-stats.org/build/html/generated/pingouin.compute_bootci.html"><code class="docutils literal notranslate"><span class="pre">compute_bootci</span></code></a> method from the <code class="docutils literal notranslate"><span class="pre">pingouin</span></code> library proves to be a valuable asset in such scenarios, as it streamlines the process of generating confidence intervals using bootstrapping. It eliminates the need for manual creation of bootstrap samples, offering a variety of methods for confidence interval computation, including the normal approximation, percentile bootstrap, and bias-corrected percentile method. Additionally, it provides the flexibility to return the entire bootstrap distribution, enabling further exploration and visualization of the resampling results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pingouin</span> <span class="k">as</span> <span class="nn">pg</span>

<span class="c1"># Calculate 95% percentile bootstrap confidence interval using pingouin</span>
<span class="n">bs_ci</span><span class="p">,</span> <span class="n">bt</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">compute_bootci</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">differences_fert</span><span class="p">,</span>  <span class="c1"># Use the array of paired differences</span>
    <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>        <span class="c1"># Calculate the mean of each bootstrap sample</span>
    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;per&#39;</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">,</span>
    <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_boot</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">return_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">bt</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>  <span class="c1"># Print the first 10 bootstrap replicate means</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;95% percentile bootstrap confidence interval (pingouin): (</span><span class="si">{</span><span class="n">bs_ci</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">bs_ci</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.525      0.53333333 4.33333333 1.19166667 1.76666667 3.875
 3.075      3.35       1.75833333 2.01666667]
95% percentile bootstrap confidence interval (pingouin): (0.192, 4.750)
</pre></div>
</div>
</div>
</div>
</section>
<section id="bootstrap-p-value-for-paired-data">
<h3>Bootstrap P value for paired data<a class="headerlink" href="#bootstrap-p-value-for-paired-data" title="Link to this heading">#</a></h3>
<p>Similar to the <a class="reference external" href="https://sbwiecko.github.io/intuitive_biostatistics/30%20-%20Comparing%20Two%20Means%20with%20Unpaired%20t%20Test.html#bootstrap-p-value">unpaired t-test</a>, bootstrapping and permutation tests offer flexibility in hypothesis testing for paired data as well. We can employ resampling techniques to generate data under the null hypothesis, allowing us to compute P values. The key lies in choosing a relevant test statistic and calculating it consistently for both the original and resampled data.</p>
<p>In the context of a paired t-test, the t-statistic and the mean (paired) difference serve as natural and straightforward test statistics. However, we can also explore other statistics like the <em>median difference</em> or even specific <em>quantile differences</em> if the research question demands it.</p>
<section id="bootstrapped-t-statistics-of-shifted-differences">
<h4>Bootstrapped t-statistics of shifted differences<a class="headerlink" href="#bootstrapped-t-statistics-of-shifted-differences" title="Link to this heading">#</a></h4>
<p>We can adapt <a class="reference external" href="https://academic.oup.com/biomet/article-abstract/68/3/589/218600?redirectedFrom=fulltext&amp;amp;login=false">Bradley Efron’s bootstrapping algorithm</a> for the paired t-test scenario. The core idea remains the same: shift the data to simulate the null hypothesis. However, instead of <a class="reference external" href="https://sbwiecko.github.io/intuitive_biostatistics/30%20-%20Comparing%20Two%20Means%20with%20Unpaired%20t%20Test.html#bootstrapped-t-statistics-of-shifted-data">shifting individual groups</a>, we shift the <em>differences</em> within each pair to have a common mean of <strong>zero</strong> (representing no difference under the null hypothesis).</p>
<p>Specifically, we create a new dataset of <em>shifted differences</em> as <span class="math notranslate nohighlight">\(d_i' = d_i - \bar d\)</span>, where <span class="math notranslate nohighlight">\(d_i\)</span> are the original paired differences and <span class="math notranslate nohighlight">\(\bar d\)</span> is their mean.</p>
<p>Next, we perform the following steps B times (e.g., B = 10000):</p>
<ol class="arabic simple">
<li><p>Draw a bootstrap sample <span class="math notranslate nohighlight">\(d_i^b\)</span> of size <span class="math notranslate nohighlight">\(n\)</span> with replacement from the shifted differences <span class="math notranslate nohighlight">\(d_i'\)</span>.</p></li>
<li><p>Calculate the t-statistic <span class="math notranslate nohighlight">\(T^b_i\)</span> using the bootstrap sample <span class="math notranslate nohighlight">\(d_i^b\)</span>.</p></li>
</ol>
</section>
<section id="one-tailed-p-value">
<h4>One-tailed P value<a class="headerlink" href="#one-tailed-p-value" title="Link to this heading">#</a></h4>
<p>To estimate the P value using bootstrapping, we assess how often the bootstrapped t-statistics (<span class="math notranslate nohighlight">\(T^b_i\)</span>) are as extreme as, or more extreme than, the observed t-statistic (<span class="math notranslate nohighlight">\(t\)</span>) from the original data. This involves generating multiple bootstrap samples, calculating the t-statistic for each, and determining the proportion of these bootstrap t-statistics that exceed the observed t-statistic.</p>
<p>Mathematically, the bootstrap p-value (<span class="math notranslate nohighlight">\(p_B\)</span>) can be expressed as:</p>
<div class="math notranslate nohighlight">
\[P(T^b \ge t | H_0) = p_B = \frac{\{\# T^b_i \ge t\}}{B}\]</div>
<p>However, when testing a directional hypothesis (one-tailed test), we need to consider the direction of the effect. If the alternative hypothesis states that the true value is less than the hypothesized value, and the observed test statistic is negative (<span class="math notranslate nohighlight">\(t &lt; 0\)</span>), the p-value is calculated as:</p>
<div class="math notranslate nohighlight">
\[p_B = \frac{\sum_{i=1}^B I\{T^b_i \le t \}}{B}\]</div>
<p>where <span class="math notranslate nohighlight">\(I\{\text{condition}\} = 1\)</span> if the <em>condition</em> is true and <span class="math notranslate nohighlight">\(0\)</span> otherwise.</p>
<p>Conversely, if the alternative hypothesis states that the true value is greater than the hypothesized value, and the observed test statistic is positive (<span class="math notranslate nohighlight">\(t &gt; 0\)</span>), the p-value is calculated as:</p>
<div class="math notranslate nohighlight">
\[p_B = \frac{\sum_{i=1}^B I\{T^b_i \ge t \}}{B}\]</div>
<p>While adding 1 to both the numerator and denominator of the p-value calculation is sometimes suggested to avoid a p-value of 0, this practice is not universally accepted.</p>
<p>And as discussed in the previous chapter, there are several approaches to calculate a <strong>two-tailed P value</strong> from a bootstrap distribution. These range from conservative methods that multiply the highest one-tailed P value by 2 to more flexible methods that sum the probabilities in both tails. Additionally, while the “99 rule” suggests that 99 replicates may be sufficient for estimating confidence intervals, particularly for the median, we’ll generally use a higher number of replicates (B = 9999) in our analyses to ensure greater precision.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the random seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">n_replicates</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># 99 rule</span>

<span class="c1"># Shift the paired differences to have a mean of zero (simulating the null hypothesis)</span>
<span class="n">shifted_differences</span> <span class="o">=</span> <span class="n">differences_fert</span> <span class="o">-</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span> <span class="c1"># type: ignore</span>

<span class="c1"># Generate 10000 bootstrap replicates of the shifted differences</span>
<span class="n">bs_shifted_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">shifted_differences</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">nobs</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicates</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Calculate the mean and standard deviation for each bootstrap replicate</span>
<span class="n">bs_shifted_diffs_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_shifted_diffs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bs_shifted_diffs_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bs_shifted_diffs</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Sample standard deviation</span>

<span class="c1"># Calculate the standard error for each replicate</span>
<span class="n">bs_se</span> <span class="o">=</span> <span class="n">bs_shifted_diffs_stds</span> <span class="o">/</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">nobs</span><span class="o">**</span><span class="mf">.5</span>

<span class="c1"># Calculate the t-statistic for each bootstrap replicate</span>
<span class="n">bs_t_statistic</span> <span class="o">=</span> <span class="n">bs_shifted_diffs_means</span> <span class="o">/</span> <span class="n">bs_se</span>

<span class="c1"># Or we calculate the t-test for the mean on the one-sample bootstrap distribution</span>
<span class="c1"># bs_t_statistic = np.array([</span>
<span class="c1">#     stats.ttest_1samp(sample, popmean=0)[0] for sample in bs_shifted_diffs</span>
<span class="c1"># ])</span>

<span class="c1"># Print the first 15 t-statistics from the bootstrap replicates</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bs_t_statistic</span><span class="p">[:</span><span class="mi">15</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 1.08228839  0.5891132   0.83625618 -1.43918435 -0.55298715  0.92978128
  0.140706    1.14955388  0.29781496 -0.73463324  2.46303042 -0.24038272
  0.75223906  0.58088937 -0.39851653]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the P value using bootstrapping, considering the direction of the observed t-statistic</span>
<span class="c1"># # 1. Calculate lower and upper tail</span>
<span class="k">if</span> <span class="n">t_statistic_paired</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># p_value_bs_shifted_low = np.sum(bs_t_statistic_welch &gt;= t_statistic_welch) / len(bs_t_statistic_welch)</span>
    <span class="n">p_value_bs_shifted_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_t_statistic</span> <span class="o">&gt;=</span> <span class="n">t_statistic_paired</span><span class="p">)</span>  <span class="c1"># Mathematically same as above</span>
    <span class="n">p_value_bs_shifted_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_t_statistic</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">t_statistic_paired</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p_value_bs_shifted_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_t_statistic</span> <span class="o">&lt;=</span> <span class="n">t_statistic_paired</span><span class="p">)</span>
    <span class="n">p_value_bs_shifted_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_t_statistic</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">t_statistic_paired</span><span class="p">)</span>

<span class="c1"># 2. Attribute the one-tailed P value</span>
<span class="n">p_value_bs_shifted_1t</span> <span class="o">=</span> <span class="n">p_value_bs_shifted_up</span> <span class="k">if</span> <span class="n">t_statistic_paired</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">p_value_bs_shifted_low</span>

<span class="c1"># Print the P value</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;One-sided P value obtained using bootstrapped paired-sample t-statistics = </span><span class="si">{</span><span class="n">p_value_bs_shifted_1t</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>One-sided P value obtained using bootstrapped paired-sample t-statistics = 0.0681
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>

<span class="c1"># Plot the histogram of the bootstrap t-statistics</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">bs_t_statistic</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_replicates</span><span class="o">**</span><span class="mf">.5</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Annotate the observed t-statistic</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">t_statistic_paired</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Observed t (</span><span class="si">{</span><span class="n">t_statistic_paired</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Determine the direction of the observed t-statistic and plot accordingly</span>
<span class="k">if</span> <span class="n">t_statistic_paired</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Plot the histogram of the bootstrap t-statistics &gt;= observed t-statistic</span>
    <span class="n">extreme_t_stats</span> <span class="o">=</span> <span class="n">bs_t_statistic</span><span class="p">[</span><span class="n">bs_t_statistic</span> <span class="o">&gt;=</span> <span class="n">t_statistic_paired</span><span class="p">]</span>
    <span class="c1"># Change the color of the bars based on the direction parameter</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bin_edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bin_edge</span> <span class="o">&gt;=</span> <span class="n">extreme_t_stats</span><span class="p">):</span>
            <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;lime&#39;</span><span class="p">)</span> <span class="c1"># type: ignore</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Plot the histogram of the bootstrap t-statistics &lt;= observed t-statistic</span>
    <span class="n">extreme_t_stats</span> <span class="o">=</span> <span class="n">bs_t_statistic</span><span class="p">[</span><span class="n">bs_t_statistic</span> <span class="o">&lt;=</span> <span class="n">t_statistic_paired</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bin_edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bin_edge</span> <span class="o">&lt;=</span> <span class="n">extreme_t_stats</span><span class="p">):</span>
            <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;lime&#39;</span><span class="p">)</span> <span class="c1"># type: ignore</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bootstrap distribution of t under H0 (B=</span><span class="si">{</span><span class="n">n_replicates</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Create a copy of the original patch for the legend</span>
<span class="n">original_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bootstrap t&#39;</span><span class="p">)</span>
<span class="c1"># Create a patch for the legend</span>
<span class="n">p_value_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;One-tailed P (</span><span class="si">{</span><span class="n">p_value_bs_shifted_1t</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Add the patches to the legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">original_patch</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_value_patch</span><span class="p">]);</span> <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/188e7be55c1d2549dd8925e5bb59d620c29c14ea4a9a34cb8cdc5294cf281aa4.png" src="_images/188e7be55c1d2549dd8925e5bb59d620c29c14ea4a9a34cb8cdc5294cf281aa4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Maximum one-tail</span>
<span class="n">p_value_bs_shifted_2t_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_value_bs_shifted_low</span><span class="p">,</span> <span class="n">p_value_bs_shifted_up</span><span class="p">)</span>

<span class="c1"># Sum of the tails</span>
<span class="n">p_value_bs_shifted_2t_sum</span> <span class="o">=</span> <span class="n">p_value_bs_shifted_low</span> <span class="o">+</span> <span class="n">p_value_bs_shifted_up</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Two-tailed paired-sample t-test bootstrap P value (conservative) = </span><span class="si">{</span><span class="n">p_value_bs_shifted_2t_max</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Two-tailed paired-sample t-test bootstrap P value (both tails) = </span><span class="si">{</span><span class="n">p_value_bs_shifted_2t_sum</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Two-tailed paired-sample t-test bootstrap P value (conservative) = 0.1362
Two-tailed paired-sample t-test bootstrap P value (both tails) = 0.0770
</pre></div>
</div>
</div>
</div>
<p>Since the distribution of the bootstrapped t-statistic obtained with paired mean differences isn’t perfectly symmetrical, it’s more accurate to calculate the two-tailed P value by summing the probabilities in both tails, even though the resulting P value is already greater than the significance level (alpha). This approach avoids relying on the symmetry assumption and provides a more robust estimate of the P value.</p>
</section>
<section id="p-value-via-permutation">
<h4>P value via permutation<a class="headerlink" href="#p-value-via-permutation" title="Link to this heading">#</a></h4>
<p>When conducting a paired t-test, permutation tests are often the preferred resampling method for creating data that would be expected if the null hypothesis were true. In this approach, we randomly <em>flip the sign</em> of each difference within a pair (changing X-Y to Y-X). This shuffling maintains the variation <em>between</em> different pairs, but it only keeps the original pattern of differences <em>within</em> each pair if the true average difference is actually zero (as the null hypothesis states).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">permute_paired_differences</span><span class="p">(</span><span class="n">differences</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a permuted sample of paired differences under the null hypothesis.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        differences: An array of paired differences.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new array with randomly negated differences within each pair.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Randomly generate -1 or 1 for each pair</span>
    <span class="n">signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">differences</span><span class="p">))</span>

    <span class="c1"># Multiply each difference by its corresponding sign</span>
    <span class="n">permuted_differences</span> <span class="o">=</span> <span class="n">differences</span> <span class="o">*</span> <span class="n">signs</span>
    <span class="k">return</span> <span class="n">permuted_differences</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we determine how frequently these permuted differences are as extreme as, or even more extreme than, the observed mean difference in our original data. This proportion represents the P value. In essence, it tells us the likelihood of observing a difference as large (or larger) as the one we found, purely by chance, if there were truly no difference between the groups (i.e., if the null hypothesis were true).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set random seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="c1"># Generate 10,000 bootstrap replicates of the mean difference for each permutation sample</span>
<span class="n">n_replicates</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># Initialize an empty array to store the permuted mean differences</span>
<span class="n">permuted_diffs_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_replicates</span><span class="p">)</span>

<span class="c1"># Generate permuted mean differences</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicates</span><span class="p">):</span>
    <span class="c1"># Permute the differences</span>
    <span class="n">permuted_diffs</span> <span class="o">=</span> <span class="n">permute_paired_differences</span><span class="p">(</span><span class="n">differences_fert</span><span class="p">)</span>
    
    <span class="c1"># Calculate the mean difference for this permuted sample</span>
    <span class="n">permuted_diffs_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs</span><span class="p">)</span>

<span class="c1"># Generate permuted mean differences using a list comprehension</span>
<span class="c1"># permuted_diffs_means = np.array(</span>
<span class="c1">#     [np.mean(permute_paired_differences(differences_fert)) for _ in range(n_replicates)])</span>

<span class="c1"># Print the first 6 replicate difference means</span>
<span class="nb">print</span><span class="p">(</span><span class="n">permuted_diffs_means</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0.88333333 -2.11666667 -0.1         0.78333333 -0.95       -2.03333333]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the P value using bootstrapping, considering the direction of the observed paired difference mean</span>
<span class="k">if</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">p_value_permutation_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs_means</span> <span class="o">&gt;=</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">p_value_permutation_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs_means</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p_value_permutation_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs_means</span> <span class="o">&lt;=</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">p_value_permutation_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs_means</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>

<span class="n">p_value_permutation_1t</span> <span class="o">=</span> <span class="n">p_value_permutation_up</span> <span class="k">if</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">p_value_permutation_low</span>

<span class="c1"># Print the P value</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;One-sided P value obtained using permutation test (mean difference) = </span><span class="si">{</span><span class="n">p_value_permutation_1t</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>One-sided P value obtained using permutation test (mean difference) = 0.0264
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the histogram of the permuted mean differences</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">permuted_diffs_means</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_replicates</span><span class="o">**</span><span class="mf">.5</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Annotate the observed mean difference</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Observed mean difference (</span><span class="si">{</span><span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Determine the direction of the observed mean difference and plot accordingly</span>
<span class="k">if</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Plot the histogram of the mean differences &gt;= observed mean difference </span>
    <span class="n">extreme_diffs</span> <span class="o">=</span> <span class="n">permuted_diffs_means</span><span class="p">[</span><span class="n">permuted_diffs_means</span> <span class="o">&gt;=</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">]</span>
    <span class="c1"># Change the color of the bars based on the direction parameter</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bin_edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bin_edge</span> <span class="o">&gt;=</span> <span class="n">extreme_diffs</span><span class="p">):</span>
            <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;lime&#39;</span><span class="p">)</span> <span class="c1"># type: ignore</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Plot the histogram of the mean differences &lt;= observed mean difference</span>
    <span class="n">extreme_diffs</span> <span class="o">=</span> <span class="n">permuted_diffs_means</span><span class="p">[</span><span class="n">permuted_diffs_means</span> <span class="o">&lt;=</span> <span class="n">differences_fert_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bin_edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bin_edge</span> <span class="o">&lt;=</span> <span class="n">extreme_diffs</span><span class="p">):</span>
            <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;lime&#39;</span><span class="p">)</span> <span class="c1"># type: ignore</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mean difference&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribution of bootstrap mean differences under H0 (B=</span><span class="si">{</span><span class="n">n_replicates</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Create a copy of the original patch for the legend</span>
<span class="n">original_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bootstrap mean difference&#39;</span><span class="p">)</span>
<span class="c1"># Create a patch for the legend</span>
<span class="n">p_value_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;One-tailed P (</span><span class="si">{</span><span class="n">p_value_permutation_1t</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Add the patches to the legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">original_patch</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_value_patch</span><span class="p">]);</span> <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8edc46f5d371758d4608c91b15f790fe210b0e594f0b35a6c9c3744488723e7e.png" src="_images/8edc46f5d371758d4608c91b15f790fe210b0e594f0b35a6c9c3744488723e7e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Maximum one-tail</span>
<span class="n">p_value_permut_2t_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_value_permutation_low</span><span class="p">,</span> <span class="n">p_value_permutation_up</span><span class="p">)</span>

<span class="c1"># Sum of the tails</span>
<span class="n">p_value_permut_2t_sum</span> <span class="o">=</span> <span class="n">p_value_permutation_low</span> <span class="o">+</span> <span class="n">p_value_permutation_up</span>

<span class="c1"># Print the results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Two-tailed permutation bootstrap P value (conservative) = </span><span class="si">{</span><span class="n">p_value_permut_2t_max</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Two-tailed permutation bootstrap P value (both tails) = </span><span class="si">{</span><span class="n">p_value_permut_2t_sum</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Two-tailed permutation bootstrap P value (conservative) = 0.0546
Two-tailed permutation bootstrap P value (both tails) = 0.0537
</pre></div>
</div>
</div>
</div>
<p>Our analysis of the paired data yielded mixed results regarding the significance of the observed difference between the groups. The frequentist paired t-test produced a borderline P value of 0.0497, suggesting a statistically significant difference at the conventional alpha level of 0.05. The non-parametric Wilcoxon signed-rank test, using both exact and asymptotic methods, also yielded borderline P values (0.04126 and 0.04089, respectively).</p>
<p>However, the bootstrap analysis with shifted differences resulted in a non-significant two-sided P value of 0.0770. This discrepancy might stem from the sensitivity of bootstrapping to small sample sizes, which can introduce variability in the results.</p>
<p>The permutation test provided the strongest evidence for a statistically significant difference, with a P value of 0.0537. While the frequentist test also hinted at a potential effect, it was less conclusive.</p>
<p>Given the borderline significance and the potential limitations of bootstrapping with small samples, interpreting these findings requires caution. Further investigation with a larger sample size or additional analyses might be necessary to confirm the presence of a true effect.</p>
</section>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>This chapter has provided a comprehensive guide to the paired t-test, a powerful statistical method for analyzing differences between paired observations. We began by establishing the foundations of the test, emphasizing its focus on assessing changes within matched pairs or repeated measurements. We then explored the crucial steps involved in preparing data for hypothesis testing, including descriptive statistics, visualization techniques, and assessing the normality assumption.</p>
<p>The core of the chapter delved into the mechanics of the paired t-test, explaining the t-ratio, its manual calculation, and its interpretation in terms of P values and confidence intervals. We demonstrated how to leverage Python libraries like <code class="docutils literal notranslate"><span class="pre">scipy.stats</span></code> and <code class="docutils literal notranslate"><span class="pre">pingouin</span></code> to streamline the analysis process and gain deeper insights from the results.</p>
<p>Furthermore, we extended our exploration to encompass variations and extensions of the paired t-test, including one-sided tests for directional hypotheses, ratio paired t-tests for analyzing proportional changes, the McNemar test for paired categorical data, and a brief introduction to the Bayesian approach for estimating the probability distribution of the mean difference.</p>
<p>Finally, we touched upon the potential of bootstrap and permutation methods to provide robust alternatives to the paired t-test, particularly when dealing with non-normal data or violations of the test’s assumptions.</p>
<p>By combining theoretical understanding with practical implementation and a consideration of various extensions and alternatives, this chapter has equipped you with the knowledge and tools to confidently apply the paired t-test in your own research endeavors. Remember that careful consideration of the research question, data characteristics, and appropriate statistical techniques is crucial for drawing meaningful and valid conclusions from paired data.</p>
</section>
<section id="cheat-sheet">
<h2>Cheat sheet<a class="headerlink" href="#cheat-sheet" title="Link to this heading">#</a></h2>
<section id="descriptive-statistics-and-visualization">
<h3>Descriptive statistics and visualization<a class="headerlink" href="#descriptive-statistics-and-visualization" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">differences</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>

<span class="c1"># Concatenate the data in a DataFrame for some operations</span>
<span class="n">data_diffs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span>
    <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Descriptive statistics</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="n">stats</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span>

<span class="c1"># Boxplots</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">differences</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">differences</span><span class="p">,)</span>

<span class="c1"># Before-after plots</span>
<span class="kn">import</span> <span class="nn">pingouin</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="n">pg</span><span class="o">.</span><span class="n">plot_paired</span><span class="p">(</span>
    <span class="c1"># We need to reshape the DataFrame in the long format</span>
    <span class="n">data</span><span class="o">=</span><span class="n">differences</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
        <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span>
        <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">),</span>
    <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span>
    <span class="n">within</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,)</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3>Assessing assumptions<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<section id="id2">
<h4>Normality testing<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using scipy.stats</span>
<span class="c1"># D&#39;Agostino-Pearson K² test</span>
<span class="n">stats</span><span class="o">.</span><span class="n">normaltest</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span>
<span class="c1"># Shapiro-Wilk</span>
<span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span>

<span class="c1"># Using pingouin</span>
<span class="n">pg</span><span class="o">.</span><span class="n">normality</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normaltest&#39;</span><span class="p">)</span>
<span class="n">pg</span><span class="o">.</span><span class="n">normality</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normaltest&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="q-q-plot">
<h4>Q-Q plot<a class="headerlink" href="#q-q-plot" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">qqplot</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="t-test">
<h3>T-test<a class="headerlink" href="#t-test" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using scipy.stats</span>
<span class="n">stats</span><span class="o">.</span><span class="n">ttest_rel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="c1"># t = stats.ttest_rel(x, y)[0]</span>

<span class="c1"># Using pingouin</span>
<span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># One-sided t-test</span>
<span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>

<span class="c1"># Ratio paired t-test</span>
<span class="c1"># Perform the paired t-test on the log-transformed data</span>
<span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
    <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>

<span class="c1"># McNemar&#39;s test</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.contingency_tables</span> <span class="kn">import</span> <span class="n">mcnemar</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mcnemar</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="c1"># Bayesian estimation</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">]])</span>
<span class="n">stats</span><span class="o">.</span><span class="n">bayes_mvs</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># Effect size (Cohen&#39;s d)</span>
<span class="c1"># Calculate unbiased Cohen&#39;s d using pingouin</span>
<span class="n">pg</span><span class="o">.</span><span class="n">compute_effsize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eftype</span><span class="o">=</span><span class="s1">&#39;Cohen&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="non-parametric-wilcoxon-signed-rank-test">
<h3>Non-parametric Wilcoxon signed-rank test<a class="headerlink" href="#non-parametric-wilcoxon-signed-rank-test" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">wilcoxon</span>

<span class="c1"># Perform Wilcoxon signed-rank test with exact p-value calculation</span>
<span class="n">wilcoxon</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>

<span class="c1"># Perform Wilcoxon signed-rank test with normal approximation p-value calculation</span>
<span class="n">wilcoxon</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;approx&#39;</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Perform Wilcoxon signed-rank test using Pingouin</span>
<span class="n">pg</span><span class="o">.</span><span class="n">wilcoxon</span><span class="p">(</span>
    <span class="n">differences</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;approx&#39;</span><span class="p">,</span>
    <span class="n">correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Pingouin applies a continuity correction by default</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="bootstrapping-and-permutation-tests">
<h3>Bootstrapping and permutation tests<a class="headerlink" href="#bootstrapping-and-permutation-tests" title="Link to this heading">#</a></h3>
<section id="bootstrap-pair-samples">
<h4>Bootstrap pair samples<a class="headerlink" href="#bootstrap-pair-samples" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate B bootstrap replicates of the mean difference, with replacement</span>
<span class="n">n_replicates</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">differences_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">differences</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">differences</span><span class="p">),</span>
            <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicates</span><span class="p">)</span>
    <span class="p">])</span>

<span class="c1"># Calculate the statistics of interest `bs` for each replicate</span>
<span class="n">bs_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">differences_means</span><span class="p">)</span>
<span class="n">bs_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">differences_means</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Confidence interval</span>
<span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">differences_means</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">])</span>

<span class="c1"># 95% normal confidence interval</span>
<span class="n">bs_w</span> <span class="o">=</span>  <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span> <span class="o">*</span> <span class="n">bs_s</span>
<span class="p">(</span><span class="n">bs_m</span> <span class="o">-</span> <span class="n">bs_w</span><span class="p">,</span> <span class="n">bs_m</span> <span class="o">+</span> <span class="n">bs_w</span><span class="p">)</span>

<span class="c1"># Bootstrapping with Pingouin</span>
<span class="n">bs_ci</span><span class="p">,</span> <span class="n">bt</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">compute_bootci</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">return_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>P value<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<section id="id4">
<h5>Bootstrapped t-statistics of shifted differences<a class="headerlink" href="#id4" title="Link to this heading">#</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n_replicates</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># 99 rule</span>

<span class="c1"># Shift the paired differences to have a mean of zero (simulating the null hypothesis)</span>
<span class="n">shifted_differences</span> <span class="o">=</span> <span class="n">differences</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span>

<span class="c1"># Generate B bootstrap replicates of the shifted differences</span>
<span class="n">bs_shifted_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">shifted_differences</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">differences</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicates</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Calculate the t-statistic for each bootstrap replicate</span>
<span class="n">bs_shifted_diffs_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_shifted_diffs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>        <span class="c1"># mean</span>
<span class="n">bs_shifted_diffs_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bs_shifted_diffs</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># std</span>
<span class="n">bs_se</span> <span class="o">=</span> <span class="n">bs_shifted_diffs_stds</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">differences</span><span class="p">))</span>         <span class="c1"># se</span>
<span class="n">bs_t</span> <span class="o">=</span> <span class="n">bs_shifted_diffs_means</span> <span class="o">/</span> <span class="n">bs_se</span>

<span class="c1"># Calculate P values using bootstrapping, considering the direction of the observed statistic</span>
<span class="c1"># 1. Calculate lower and upper tail</span>
<span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">p_value_bs_t_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_t</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">p_value_bs_t_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_t</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">t</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p_value_bs_t_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_t</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">p_value_bs_t_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs_t</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">t</span><span class="p">)</span>

<span class="c1"># 2. Attribute the one-tailed P value</span>
<span class="n">p_value_bs_t_up</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">p_value_bs_t_low</span>

<span class="c1"># 3. Attribute the two-tailed P values</span>
<span class="c1"># Maximum one-tail</span>
<span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_value_bs_t_low</span><span class="p">,</span> <span class="n">p_value_bs_t_up</span><span class="p">)</span>

<span class="c1"># Sum of the tails</span>
<span class="n">p_value_bs_t_low</span> <span class="o">+</span> <span class="n">p_value_bs_t_up</span>
</pre></div>
</div>
</section>
<section id="permutation">
<h5>Permutation<a class="headerlink" href="#permutation" title="Link to this heading">#</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">permute_paired_differences</span><span class="p">(</span><span class="n">differences</span><span class="p">):</span>
    <span class="c1"># Randomly generate -1 or 1 for each pair</span>
    <span class="n">signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">differences</span><span class="p">))</span>
    <span class="c1"># Multiply each difference by its corresponding sign</span>
    <span class="n">permuted_differences</span> <span class="o">=</span> <span class="n">differences</span> <span class="o">*</span> <span class="n">signs</span>

    <span class="k">return</span> <span class="n">permuted_differences</span>

<span class="n">permuted_diffs_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permute_paired_differences</span><span class="p">(</span><span class="n">differences</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicates</span><span class="p">)</span>
    <span class="p">])</span>

<span class="c1"># Calculate permutation P values</span>
<span class="n">diff_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span>
<span class="k">if</span> <span class="n">mean_diff</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">p_value_permutation_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs_means</span> <span class="o">&gt;=</span> <span class="n">diff_mean</span><span class="p">)</span>
    <span class="n">p_value_permutation_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs_means</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">diff_mean</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p_value_permutation_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs_means</span> <span class="o">&lt;=</span> <span class="n">diff_mean</span><span class="p">)</span>
    <span class="n">p_value_permutation_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permuted_diffs_means</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">diff_mean</span><span class="p">)</span>

<span class="c1"># One-tailed P value</span>
<span class="n">p_value_permutation_up</span> <span class="k">if</span> <span class="n">diff_mean</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">p_value_permutation_low</span>

<span class="c1"># Two-tailed P values</span>
<span class="c1"># Maximum one-tail</span>
<span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_value_permutation_low</span><span class="p">,</span> <span class="n">p_value_permutation_up</span><span class="p">)</span>

<span class="c1"># Sum of the tails</span>
<span class="n">p_value_permutation_low</span> <span class="o">+</span> <span class="n">p_value_permutation_up</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>
<section id="session-information">
<h2>Session information<a class="headerlink" href="#session-information" title="Link to this heading">#</a></h2>
<p>The output below details all packages and version necessary to reproduce the results in this report.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>--version
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">importlib.metadata</span> <span class="kn">import</span> <span class="n">version</span>

<span class="c1"># List of packages we want to check the version</span>
<span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="s1">&#39;seaborn&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;pingouin&#39;</span><span class="p">,</span> <span class="s1">&#39;statsmodels&#39;</span><span class="p">]</span>

<span class="c1"># Initialize an empty list to store the versions</span>
<span class="n">versions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop over the packages</span>
<span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get the version of the package</span>
        <span class="n">package_version</span> <span class="o">=</span> <span class="n">version</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
        <span class="c1"># Append the version to the list</span>
        <span class="n">versions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">package_version</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># Use a more general exception for broader compatibility</span>
        <span class="n">versions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Not installed&#39;</span><span class="p">)</span>

<span class="c1"># Print the versions</span>
<span class="k">for</span> <span class="n">package</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">versions</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Python 3.12.7
-------------
numpy: 1.26.4
pandas: 2.2.2
matplotlib: 3.9.2
seaborn: 0.13.2
scipy: 1.14.1
pingouin: 0.5.5
statsmodels: 0.14.2
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="30%20-%20Comparing%20two%20unpaired%20means.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Comparing two unpaired means</p>
      </div>
    </a>
    <a class="right-next"
       href="32%20-%20Correlation.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Correlation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-data-for-hypothesis-testing">Preparing data for hypothesis testing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#descriptive-statistics">Descriptive statistics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-visualization">Data visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-assumptions">Assessing assumptions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#normality-testing">Normality testing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#note-on-homoscedasticity">Note on homoscedasticity</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-the-significance-of-paired-difference-mean-with-t-test">Assessing the significance of paired difference mean with t-test</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-t-ratio">The t-ratio</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#manual-calculation">Manual calculation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#p-value">P value</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-test-results">Visualizing the test results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-interval">Confidence interval</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-the-paired-t-test-in-python">Performing the paired t-test in Python</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#follow-up-analyses">Follow-up analyses</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#effect-size">Effect size</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-effectiveness-of-pairing">Evaluating the effectiveness of pairing</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extensions-of-the-paired-t-test">Extensions of the paired t-test</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-sided-t-test">One-sided t-test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ratio-paired-t-test">Ratio paired t-test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mcnemar-s-test">McNemar’s test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bayesian-approach">Bayesian approach</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-parametric-approach">Non-parametric approach</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-the-wilcoxon-signed-rand-test-manually">Performing the Wilcoxon signed-rand test manually</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exact-test">Exact test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#asymptotic-approach">Asymptotic approach</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-tools-for-the-non-parametric-paired-t-test">Python tools for the non-parametric paired t-test</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapping-and-permutation-tests-for-paired-data">Bootstrapping and permutation tests for paired data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-bootstrap-pair-samples">Generating bootstrap pair samples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-of-the-confidence-interval-for-the-paired-difference-mean">Estimate of the confidence interval for the paired difference mean</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapping-with-pingouin">Bootstrapping with Pingouin</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrap-p-value-for-paired-data">Bootstrap P value for paired data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapped-t-statistics-of-shifted-differences">Bootstrapped t-statistics of shifted differences</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-tailed-p-value">One-tailed P value</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#p-value-via-permutation">P value via permutation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cheat-sheet">Cheat sheet</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#descriptive-statistics-and-visualization">Descriptive statistics and visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Assessing assumptions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Normality testing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#q-q-plot">Q-Q plot</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test">T-test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#non-parametric-wilcoxon-signed-rank-test">Non-parametric Wilcoxon signed-rank test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapping-and-permutation-tests">Bootstrapping and permutation tests</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrap-pair-samples">Bootstrap pair samples</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">P value</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Bootstrapped t-statistics of shifted differences</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#permutation">Permutation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#session-information">Session information</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sébastien Wieckowski
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>